---
title: Virtual machine in C++
---

This is not a tutorial. This post is a flashback I had today. It might be a bit fiction as my memory about events tends to be fuzzy at times. But I promise it at least resembles the real story.<br />I was in <a href="http://en.wikipedia.org/wiki/Elementary_school" rel="wikipedia" target="_blank" title="Elementary school">elementary school</a> and just found out about programming and was learning about c++. After reading "<a href="http://en.wikipedia.org/wiki/C%2B%2B" rel="wikipedia" target="_blank" title="C++">C++</a> na kolenih" by Goran Bervar I was empowered by knowledge and tried to do all sorts of projects. Mostly in console. Stuff like subtitle format converter - <a href="http://en.wikipedia.org/wiki/Not_Invented_Here" rel="wikipedia" target="_blank" title="Not Invented Here">NIH syndrome</a>. I was a bit frustrated because I couldn't find any books about windows programming in the library. Yes, library was may primary source of information, because my <a href="http://en.wikipedia.org/wiki/English_language" rel="wikipedia" target="_blank" title="English language">English</a> was not nearly good enough for technical stuff.<br />I might add here I worked on <a href="http://www.microsoft.com/WINDOWS" rel="homepage" target="_blank" title="Windows">Windows</a> 98(and later XP) with <a href="http://www.bloodshed.net%2c/" rel="homepage" target="_blank" title="Dev-C++">DevC++</a>. I found out about <a href="http://www.microsoft.com/visualstudio/en-us" rel="homepage" target="_blank" title="Microsoft Visual Studio">Visual Studio</a> in a few years and did some Windows development.<br />I digressed a bit. Then came the most optimistic idea. A <a href="http://www.symantec.com/theme.jsp?themeid=protect-virtual-environments" rel="symantec" target="_blank" title="Virtual machine">virtual machine</a>. Something quite high level(instruction to print) an eventually an assembler. I now realize I was always <a href="http://edofic.blogspot.com/2012/08/making-programming-language-part-1-how.html" target="_blank">into language stuff</a>. So a designed a <a href="http://en.wikipedia.org/wiki/Machine_code" rel="wikipedia" target="_blank" title="Machine code">machine language</a> with just enough instructions to do <a href="http://en.wikipedia.org/wiki/Hello_world_program" rel="wikipedia" target="_blank" title="Hello world program">Hello World</a>, that is PRINT and END.<br /><h3>Implementation</h3><div>At first I thought about doing a monolithic structure - <a href="http://en.wikipedia.org/wiki/Switch_statement" rel="wikipedia" target="_blank" title="Switch statement">switch case</a>(in fact what I've <a href="http://edofic.blogspot.com/2012/08/making-programming-language-part-1-how.html" target="_blank">done with scrat recently</a>). But I had some considerations. What if number of of instruction rises a lot? I'll be left maintaining <a href="http://en.wikipedia.org/wiki/Spaghetti_code" rel="wikipedia" target="_blank" title="Spaghetti code">spaghetti code</a>. Or at least I thought that's what spaghetti code looks like, but in retrospective I believe I had a good taste anyway. </div><div>But I tried that anyway. Just for kicks. Did whole machine as one class that had an array for memory and a single point of entry - boot. It run a loop a while loop with <a href="http://en.wikipedia.org/wiki/Personal_computer" rel="wikipedia" target="_blank" title="Personal computer">PC</a><-PC+1, fetched instruction from memory, switched on them, called appropriate method to implement that instruction and looped. Even had registers. I think my current professor of Computer Architecture(this course brought back the memory) might actually be proud if he heard what I did back then. </div><h3>Pointers</h3><div>I was always quite comfortable with pointers. I don't now, they're mathematicky concept. I like such stuff. Or perhaps it was because I was young when I was introduced into the matter and wasn't spoiled with automatic memory management(which I quite like nowadays). </div><div>So I tried with <a href="http://en.wikipedia.org/wiki/Function_pointer" rel="wikipedia" target="_blank" title="Function pointer">function pointers</a>. C is cool enough to let you have pointers to functions! And that means <a href="http://en.wikipedia.org/wiki/Higher-order_function" rel="wikipedia" target="_blank" title="Higher-order function">higher order functions</a>. But I didn't know about math enough to appreciate the concept as I do now. But still - I thought it's extremely cool. So I did a function that halted execution and printed out "no such instruction". Why you ask? Well I did a 256-cell table(8-bit instruction) of pointers to functions. Now I didn't have to switch - just a look-up and invocation. Great. Apart from the fact it doesn't work. </div><div>Compiler said something along the lines of "You cannot make a table of pointers to functions!". I was puzzled. Skip 10 years into the future. Today I was rethinking this and thought about casting the pointer. All the functions would be void->void so I can cast back no problem. A table of <a href="http://en.wikipedia.org/wiki/Pointer_%28computing%29" rel="wikipedia" target="_blank" title="Pointer (computing)">void pointers</a> and casting. Yay!</div><div>Now 10 years back. I didn't think about casting the pointer. Type info was sacred to me!</div><div>So I "invented" <a href="http://en.wikipedia.org/wiki/Function_object" rel="wikipedia" target="_blank" title="Function object">function objects</a>.</div><h3>Objects</h3><div>I swear to god I have not heard about function objects back then. It wasn't until this year reading Bloch's Efficient Java where he talks about strategy objects. I immediately recognized my idea. So now I had many classes, every one implementing execute method. And I had an array of these objects. Now I did a look-up and invocation on an object. Sweet. And it even worked. But sadly I dropped the project and went on to graphics. Learnt SDL and did Tic-Tac-Toe. And dreamed about doing a vector 3D engine(curves baby!). Which until this day I didn't try to implement. Maybe I'll try in near future. </div><br /><div style="margin-top: 20px; overflow: hidden;">