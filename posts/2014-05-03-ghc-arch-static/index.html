<!doctype html><html><head><title>Static linking with GHC on ArchLinux</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/vendor/js/jquery.min.js></script><script src=/vendor/js/popper.min.js></script><script src=/vendor/js/bootstrap.min.js></script><script src=/vendor/js/smooth-scroll.polyfills.min.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><script src=/vendor/js/vue.min.js></script><link rel=stylesheet href=/scss/journal.min.3bdd3e0bba961aa48fdce1402e6f01783c435b4dfb0025c8d0022ddaea0f3d19.css media=screen><script src=/js/loadCSS.js></script><script>loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");</script></head><body><div id=app><div ref=sideContainer class=side-container><div class="a-block nav-head false"><div class=nav-title>My Programming Escapades</div><div class=nav-subtitle>Andraz Bajt</div><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div class=nav-link-list><a class="a-block nav-link-item" href=/about>About Me</a>
<a class="a-block nav-link-item" href=/>Archive</a></div><div class=nav-footer>&copy;
2021
Andraz Bajt</div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item" href=/about>About Me</a>
<a class="a-block drawer-menu-item" href=/>Archive</a></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a ref=navTitle class=navbar-brand href=/>My Programming Escapades</a></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=/><div class=single-column-header-title>My Programming Escapades</div><div class=single-column-header-subtitle>Andraz Bajt</div></a><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only style="background-image:url('/')"><div class=post-title>Static linking with GHC on ArchLinux<div class=post-meta><time itemprop=datePublished>2014-05-03</time></div></div></div><div class=post-body-wrapper><div class=post-body><p>There are many reasons why to prefer dynamic linking to static but I'll not go through them. Sometimes you just want static linking, period. In my case it was to show that <a href=http://golang.org/>Go</a>&lsquo;s static executables without dependencies are not something special and other languages can do it as good as well - Haskell included.
My compiler of choice is GHC and I'm running ArchLinux. More on why this is important later.</p><p>Firstly I'll need I file to test - <code>Main.hs</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#66d9ef>module</span> Main <span style=color:#66d9ef>where</span>

<span style=color:#a6e22e>main</span> <span style=color:#f92672>=</span> putStrLn <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Hello static world</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><p>Then a quick search supplied me with the command line to compile this statically</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ghc -O -static -threaded -optl-static Main.hs
</code></pre></div><p><code>-O</code> is for optimizations, <code>-static</code> instructs GHC to do static compilation, <code>-threaded</code> includes <em>pthread</em> and <code>-optl-static</code> pushes <code>-static</code> flag to <code>ld</code>.</p><p>But it didn't work. Instead I got a bunch of errors from <code>ld</code> telling me I'm missing <code>librt</code> and <code>libgmp</code>. Running <code>locate librt</code> turned up results as well as <code>locate libgmp</code>. I was flabbergasted.</p><p>Then I tried running the same thing on Ubuntu 12.04 LTS and it worked. The resulting binary also run on my Arch without problems. Now I was just sad. I tried searching online for my problem but apparently my google-fu is insufficient. I also tried setting <em>gold</em> as preferred linker but to no avail.</p><h3 id=few-weeks-later>Few weeks later</h3><p>Today I was playing around with C and when I got something working I decided to link it statically so I can send it off to a colleague who doesn't have all these obscure libraries installed. And I hit into a similar problem. Now it couldn't find <code>libgc</code> - a library I was using that worked like a charm when using dynamic linking.</p><p>Apparently the problem didn't lie in GHC but in my linker. Time to put on my Sherlock Holmes hat and investigate.</p><p>Turns out I'm a bloody ignorant idiot. There are dynamic libraries(with <code>.so</code> extension) and there are static libraries(with <code>.a</code> extension). I remember knowing this once. And I had all dynamic libraries installed but not static. This was the root of my problems with GHC and now with GCC.</p><p>More researching turned up that Arch shies away from providing static libraries in order to encourage dynamic linking. If you want static objects you'll have to build them from source.</p><h3 id=solution>Solution</h3><p>I build <code>libgmp</code> and then also <code>libc</code> in order to get <code>librt</code> out. It wasn't that long. But for your convenience here are the resulting files if you want them <a href=../files/libgmp.a>libgmp.a</a> <a href=../files/librt.a>librt.a</a></p><p>I dumped those into <code>/usr/local/lib</code> because I didn't want to pollute my global libraries. Now I just need to convince GHC to use them. Easy. Just set <code>LD_LIBRARY_PATH</code> to that path.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>LD_LIBRARY_PATH<span style=color:#f92672>=</span>/usr/local/lib ghc -O -static -threaded -optl-static Main.hs
</code></pre></div><p>And it works. Now I'm happy.</p><hr width=100%><p style=color:#777>Last modified on 2014-05-03</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2014-10-05-haskell-apis/>Next<br>Approaches to designing a Haskell API</a>
<a class=older-posts href=/posts/2014-04-14-free-coroutines/>Previous<br>Coroutines for free</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=single-column-footer>&copy;
2021
Andraz Bajt</div></div><script src=//js/journal.js></script></body></html>