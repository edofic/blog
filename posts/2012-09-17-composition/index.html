<!doctype html><html><head><title>Pretty function composition in scala and asynchronous function composition on android</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><style>body{max-width:800px;margin:auto;line-height:1.6;font-size:18px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}.nav a,.nav a:visited,.nav a:hover,.nav a:active{color:inherit}.nav .title{margin:0}.nav-sub{display:inline-block}.nav-item{margin:5px}.nav-sub-right{display:inline-block;float:right}.nav-icon{margin-right:5px}.main img{display:block;max-width:100%;margin:auto}.main pre{overflow:auto}" media="screen"></style></head><body><div class=nav><a href=/><h2 class=title>Andraž Bajt's blog</h2></a><div class=nav-sub><a class=nav-item href=/about/>About Me</a>
<a class=nav-item href=/>Archive</a></div><div class=nav-sub-right><a class=nav-icon href=https://github.com/edofic target=_blank><img src=/icons/github.svg width=20 height=20></a>
<a class=nav-icon href=https://www.linkedin.com/in/edofic target=_blank><img src=/icons/linkedin.svg width=20 height=20></a>
<a class=nav-icon href=https://twitter.com/edofic target=_blank><img src=/icons/twitter.svg width=20 height=20></a>
<a class=nav-icon href=/index.xml target=_blank><img src=/icons/rss.svg width=20 height=20></a>
<a class=nav-icon href=mailto:blog@edofic.com target=_blank><img src=/icons/email.svg width=20 height=20></a></div></div><hr><div class=main><h1>Pretty function composition in scala and asynchronous function composition on android</h1><time>2012-09-17</time><hr><p><a href=http://commons.wikipedia.org/wiki/File%3ASurjective_composition.svg><img src=http://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Surjective_composition.svg/300px-Surjective_composition.svg.png alt="Surjective composition: the first function nee&amp;hellip;"></a>
Surjective composition: the first function need not be surjective. (Photo credit: <a href=http://commons.wikipedia.org/wiki/File%3ASurjective_composition.svg>Wikipedia</a>)</p><p>Function composition is a nice way to sequence transformations on data.
For example in a
<a href=http://en.wikipedia.org/wiki/Compiler title=Compiler>compiler</a> you take
your source, <a href=http://en.wikipedia.org/wiki/Parsing title=Parsing>parse</a>,
check, optimize and generate code(in a nutshell). It&rsquo;s a linear series
of transformations -> perfect for <a href=http://en.wikipedia.org/wiki/Function_composition title="Function composition">function
composition</a>
In <a href=http://haskell.org/ title="Haskell (programming language)">Haskell</a> you
can use this beautiful
<a href=http://en.wikipedia.org/wiki/Syntax title=Syntax>syntax</a></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-haskell data-lang=haskell><span style=display:flex><span><span style=color:#a6e22e>compile</span> <span style=color:#f92672>=</span> codegen <span style=color:#f92672>.</span> optimize <span style=color:#f92672>.</span>check <span style=color:#f92672>.</span> parse
</span></span></code></pre></td></tr></table></div></div><p>leaving out the parameters and noting composition
as &ldquo;.&rdquo; which kinda looks like ° used in math(if you squint a bit). In
scala you could do something like</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> compile <span style=color:#66d9ef>=</span> codegen compose optimize compose check compose parse
</span></span></code></pre></td></tr></table></div></div><p>Nearly there, I just want it to look a bit prettier. (Compose is a
method defined on Function1 trait) So I define an <a href=http://en.wikipedia.org/wiki/Type_conversion title="Type conversion">implicit
conversion</a>
from function to &ldquo;composable&rdquo;</p><pre><code>implicit def function2composable[A,B](f: A=&gt;B) = new AnyRef{
  def --&gt;[C](g: B=&gt;C) = v =&gt; g(f(c))
}
</code></pre><p>This creates an object and reimplements &ldquo;compose&rdquo; but I really like the
syntax:</p><pre><code>compile = parse --&gt; check --&gt; optimize --&gt; codegen
</code></pre><p><a href=http://en.wikipedia.org/wiki/Functional_programming title="Functional programming">Functional programming</a>
can be imagined as a <a href=http://swizec.com/blog/my-brain-cant-handle-oop-anymore/swizec/4320>waterfall of data</a>,
flowing from one function into the next, and the <code>--></code> operator
represents this nicely. Let&rsquo;s go a step further. If the composition is
one-off, and this is a waterfall of
<a href=http://en.wikipedia.org/wiki/Data title=Data>DATA</a> it could be nice to
represent that. Something like</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> result <span style=color:#66d9ef>=</span> source <span style=color:#f92672>--&gt;</span> parse <span style=color:#f92672>--&gt;</span> check <span style=color:#f92672>--&gt;</span> optimize <span style=color:#f92672>--&gt;</span> codegen
</span></span></code></pre></td></tr></table></div></div><p>So now I&rsquo;m taking a value and sending it through black boxes. Very nice.
Apart from the fact it doesn&rsquo;t work(yet!).</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>def</span> any2waterfall<span style=color:#f92672>[</span><span style=color:#66d9ef>A</span><span style=color:#f92672>](</span>a<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>A</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AnyRef</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#f92672>--&gt;[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>A</span><span style=color:#f92672>=&gt;</span>B<span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> f<span style=color:#f92672>(</span>a<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p><a href=http://www.scala-lang.org/ title="Scala (programming language)">Scala</a>&rsquo;s
awesome compiler can handle two implicit conversions with same method
names. Nice. You can even mix and match</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>val</span> result <span style=color:#66d9ef>=</span> source <span style=color:#f92672>--&gt;</span> <span style=color:#f92672>(</span>parse <span style=color:#f92672>--&gt;</span> check <span style=color:#f92672>--&gt;</span> optimize<span style=color:#f92672>)</span> <span style=color:#f92672>--&gt;</span> codegen
</span></span></code></pre></td></tr></table></div></div><p>This does the composition of parse, check and optimize into an anonymous
function, applies it to the source and then applies codegen to it&rsquo;s
result.</p><h3 id=goin-async>Goin async</h3><p>What about asynchronous calls? Can I compose those too? I think it&rsquo;s
possible with Lift actors(or with scalaz&rsquo;s?), but I needed to integrate
that into <a href=http://code.google.com/android/ title=Android>Android</a>&rsquo;s
activities quite recently. Well I did not <em>need</em> to do it, but it was
quite a nice solution.</p><p>The usual way of doing things async in Android is with
the conveniently named AsyncTask. The problem is - you can&rsquo;t subclass it
in scala because of some compiler bug regarding varargs parameters.
Silly.</p><p>So let&rsquo;s do a lightweight(in terms of code) substitution. We can &ldquo;spawn
a thread&rdquo; using scala&rsquo;s actors. And activity can receive messages
through a Handler.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>import</span> android.os.<span style=color:#f92672>{</span><span style=color:#a6e22e>Message</span><span style=color:#f92672>,</span> <span style=color:#a6e22e>Handler</span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>MessageHandler</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> handler <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Handler</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> handleMessage<span style=color:#f92672>(</span>msg<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Message</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>     react<span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span>obj<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> react<span style=color:#f92672>(</span>msg<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>AnyRef</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#f92672>!(</span>message<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>AnyRef</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>val</span> msg <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Message</span>
</span></span><span style=display:flex><span>   msg<span style=color:#f92672>.</span>obj <span style=color:#66d9ef>=</span> message
</span></span><span style=display:flex><span>   handler<span style=color:#f92672>.</span>sendMessage<span style=color:#f92672>(</span>msg<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>So in an activity that mixes in MessageHandler I can post messages to my
self. And I can do it async since Handler is thread safe</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>def</span> react<span style=color:#f92672>(</span>msg<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>AnyRef</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> msg <span style=color:#66d9ef>match</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> s<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Toast</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> s<span style=color:#f92672>,</span> <span style=color:#a6e22e>Toast</span><span style=color:#f92672>.</span><span style=color:#a6e22e>LENGTH_LONG</span><span style=color:#f92672>).</span>makeText<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> <span style=color:#66d9ef>_</span> <span style=color:#66d9ef>=&gt;</span> <span style=color:#f92672>()</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//somewhere inside UI thread
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> actors.Actor.actor
</span></span><span style=display:flex><span><span style=color:#66d9ef>val</span> that <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>this</span>
</span></span><span style=display:flex><span>actor<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>val</span> msg <span style=color:#66d9ef>=</span> doExpensiveWork<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>  that <span style=color:#f92672>!</span> msg
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></td></tr></table></div></div><p>Not the most concise way to write it, but I believe the most clear one.
Method doExpensiveWork is done in the background so it doesn&rsquo;t block UI
and it posts the result back as a message.</p><h4 id=asynchttpenwikipediaorgwikiasynchrony-asynchrony-composition---finally><a href=http://en.wikipedia.org/wiki/Asynchrony title=Asynchrony>Async</a> composition - finally</h4><p>What I want to do now is use function composition to do something like</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#f92672>(</span>input <span style=color:#f92672>--&gt;</span> expensiveOne <span style=color:#f92672>--&gt;</span> expensiveTwo<span style=color:#f92672>)</span> <span style=color:#f92672>-!&gt;</span> displayResults
</span></span></code></pre></td></tr></table></div></div><p>In other words, do &ldquo;waterfall composition&rdquo; in background using some
input I have now and post the result back into the UI thread to method
displayResults. That should be the magic of the -!> operator. Do the
left side in bg and post it to the right side async. I need a new trait
for that</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>MessageHandlerExec</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>MessageHandler</span> <span style=color:#f92672>{</span> outer <span style=color:#66d9ef>=&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>val</span> handler <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Handler</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>def</span> handleMessage<span style=color:#f92672>(</span>msg<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Message</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> msg<span style=color:#f92672>.</span>obj <span style=color:#66d9ef>match</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> r<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Runnable</span> <span style=color:#f92672>=&gt;</span> r<span style=color:#f92672>.</span>run<span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> other<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>AnyRef</span> <span style=color:#f92672>=&gt;</span> react<span style=color:#f92672>(</span>other<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>def</span> any2asyncComposable<span style=color:#f92672>[</span><span style=color:#66d9ef>A</span><span style=color:#f92672>](</span>a<span style=color:#66d9ef>:</span> <span style=color:#f92672>=&gt;</span> A<span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AnyRef</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#f92672>-!&gt;[</span><span style=color:#66d9ef>B</span><span style=color:#f92672>](</span>f<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>A</span><span style=color:#f92672>=&gt;</span>B<span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> outer <span style=color:#f92672>!</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Runnable</span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>def</span> run<span style=color:#f92672>()</span> <span style=color:#66d9ef>=</span> f<span style=color:#f92672>(</span>a<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The trick here is using by-name parameters in the implicit conversion.
This delays the execution of a(which in example above would be a
waterfall and moves it into a worker thread.</p><hr><p>Last modified on 2012-09-17</p><a href=/posts/2012-09-02-creating-a-language-5/>Previous Making a programming language Part 5 - variables and decisions</a><br><a href=/posts/2012-09-21-power-sets/>Next Power sets</a></div><script src=/js/instantclick.min.js data-no-instant></script>
<script data-no-instant>InstantClick.init("mousedown")</script></body></html>