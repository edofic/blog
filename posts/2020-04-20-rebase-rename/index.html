<!DOCTYPE html>
<html>
<head>
<title>Rename rebase with git</title>
<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">




<style>body{max-width:800px;margin:auto;line-height:1.6;font-size:18px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}.nav a,.nav a:visited,.nav a:hover,.nav a:active{color:inherit}.nav .title{margin:0}.nav-sub{display:inline-block}.nav-item{margin:5px}.nav-sub-right{display:inline-block;float:right}.nav-icon{margin-right:5px}.main img{display:block;max-width:100%;margin:auto}.main pre{overflow:auto}" media="screen"></style>
</head>
    <body>
        <div class="nav">
            <a href="/"><h2 class="title">Andra≈æ Bajt&#39;s blog</h2></a>
            <div class="nav-sub">
                
                    <a class="nav-item" href="/about/">
                        About Me
                    </a>
                
                    <a class="nav-item" href="/">
                        Archive
                    </a>
                
            </div>
            <div class="nav-sub-right">
                
                    <a class="nav-icon" href="https://github.com/edofic" target="_blank"><img src="/icons/github.svg" width="20" height="20"/></a>
                
                
                    <a class="nav-icon" href="https://www.linkedin.com/in/edofic" target="_blank"><img src="/icons/linkedin.svg" width="20" height="20"/></a>
                
                
                    <a class="nav-icon" href="https://twitter.com/edofic" target="_blank"><img src="/icons/twitter.svg" width="20" height="20"/></a>
                
                <a class="nav-icon" href="/index.xml" target="_blank"><img src="/icons/rss.svg" width="20" height="20"/></a>
                
                    <a class="nav-icon" href="mailto:blog@edofic.com" target="_blank"><img src="/icons/email.svg" width="20" height="20"/></a>
                
            </div>
        </div>
        <hr/>
        <div class="main">
    <h1>Rename rebase with git</h1>
    
        <time>2020-04-20</time>
    
    
    
    <hr/>
    <p>Want to perform a <code>git rebase</code> in which you rename a file without pesky
conflicts?</p>
<p>tl;dr</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">git filter-branch -f --tree-filter <span style="color:#e6db74">&#34;git mv ORIGINAL_FILE_NAME NEW_FILE_NAME || true&#34;</span> -- <span style="color:#66d9ef">$(</span>git merge-base origin/master HEAD<span style="color:#66d9ef">)</span>..HEAD
git rebase origin/master
</code></pre></td></tr></table>
</div>
</div><p>Ever wanted to rename a file you created/modified in a pull request but also
wanted to keep the pristine history you worked hard for? Well tough luck you
can either push a new commit to rename it (and keep old commits with the old
file name) or resolve a bunch of pointless conflicts. There must be a better
way&hellip;</p>
<p>Turns out you can have your commit history and eat it too! You can tell the git
to go through your history and do the rename on each commit <em>and then</em> rebase.</p>
<p>Let&rsquo;s walk through the steps. First we need to figure out which commits are
affected. To start of we need to find what git calls a &ldquo;merge base&rdquo; - the
nearest common ancestor with the target branch. This is the point from which
commits will be considered by e.g. GitHub when you open a pull request.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">git merge-base origin/master HEAD
</code></pre></td></tr></table>
</div>
</div><p>Assuming the target repo is <code>origin</code> and the target branch is <code>master</code>. <code>hEAD</code>
just points to whatever is currently checked out this will give use the merge
base commit hash.</p>
<p>We get the full commit range with the <code>..</code> operator. We can put the merge-base
command into a subshell to build up our one-liner</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash"><span style="color:#66d9ef">$(</span>git merge-base origin/master HEAD<span style="color:#66d9ef">)</span>..HEAD
</code></pre></td></tr></table>
</div>
</div><p><em>NONE</em> this is not valid bash but a git construct to be used in further parameters.</p>
<p>And here comes the main star - git command to rewrite history: <code>git filter-branch</code>. It has many options and modes - read the docs for more info, here we&rsquo;ll just focus on our use case.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">git filter-branch -f --tree-filter <span style="color:#e6db74">&#34;git mv ORIGINAL_FILE_NAME NEW_FILE_NAME || true&#34;</span> -- <span style="color:#66d9ef">$(</span>git merge-base origin/master HEAD<span style="color:#66d9ef">)</span>..HEAD
</code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s walk through each part.</p>
<ul>
<li><code>filter-branch</code> is a command that rewrites a given set of commits using given commands</li>
<li><code>-f</code> is a <em>force</em> so we don&rsquo;t need extra confirmations - feel free to skip this one</li>
<li><code>--tree-filter</code> - this tells git we want to rewrite <em>file trees</em> meaning it will
checkout each tree, run our command and commit it back (using something like and amend)</li>
<li><code>&quot;git mv ORIGINAL_FILE_NAME NEW_FILE_NAME || true&quot; </code> this is our rename command.
We use <code>git mv</code> instead of plain <code>mv</code> so the result gets added to index automatically.
We add <code>|| true</code> so the exit code is 0 even if the file is missing - great for working
with larger histories.</li>
<li><code>-- $(git merge-base origin/master HEAD)..HEAD</code> and here comes our commit range expression.
Mind the space after <code>--</code> - this is <code>filter-branch</code> syntax to separate commits from
everything else.</li>
</ul>
<p>Then wait a bit (yes <code>filter-branch</code> may be quite slow)&hellip;..And we&rsquo;re done.
Well, almost. Still need to do the actual rebase - thus far we&rsquo;ve only done the
rename.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">git rebase origin/master
</code></pre></td></tr></table>
</div>
</div><p>My original use case was rebasing migrations that use sequence numbers as file names - you run into conflicts whenever somebody else merges any migration. So I&rsquo;ve created an alias and put it into my <code>~/.gitconfig</code></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>alias<span style="color:#f92672">]</span>
  rebase-migration <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;!f() { git filter-branch -f --tree-filter \&#34;git mv migrations/</span>$1<span style="color:#e6db74">.sql migrations/</span>$2<span style="color:#e6db74">.sql || true\&#34; -- </span><span style="color:#66d9ef">$(</span>git merge-base $3 HEAD<span style="color:#66d9ef">)</span><span style="color:#e6db74">..HEAD; git rebase </span>$3<span style="color:#e6db74">; }; f&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Now I can simply run</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-bash" data-lang="bash">git rebase-migration <span style="color:#ae81ff">76</span> <span style="color:#ae81ff">77</span> origin/develop
</code></pre></td></tr></table>
</div>
</div>
    <hr/>
    
        <p>Last modified on 2020-04-20</p>
    
    
        <a href="/posts/2020-01-15-hugo/">
            Previous Moving to Hugo
        </a>
    
    <br/>
    
    <a href="/posts/2020-06-07-linux-gaming/">
        Next Surprising ease of gaming on Linux in 2020
    </a>
    

        </div>
        <script src="/js/instantclick.min.js" data-no-instant></script>
        <script data-no-instant>InstantClick.init("mousedown");</script>
    </body>
</html>
