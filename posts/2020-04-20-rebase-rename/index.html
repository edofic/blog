<!doctype html><html><head><title>Rename rebase with git</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/vendor/js/jquery.min.js></script><script src=/vendor/js/popper.min.js></script><script src=/vendor/js/bootstrap.min.js></script><script src=/vendor/js/smooth-scroll.polyfills.min.js></script><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><script src=/vendor/js/vue.min.js></script><link rel=stylesheet href=/scss/journal.min.3bdd3e0bba961aa48fdce1402e6f01783c435b4dfb0025c8d0022ddaea0f3d19.css media=screen><script src=/js/loadCSS.js></script><script>loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");</script></head><body><div id=app><div ref=sideContainer class=side-container><div class="a-block nav-head false"><div class=nav-title>My Programming Escapades</div><div class=nav-subtitle>Andraz Bajt</div><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div class=nav-link-list><a class="a-block nav-link-item" href=/about>About Me</a>
<a class="a-block nav-link-item" href=/>Archive</a></div><div class=nav-footer>&copy;
2021
Andraz Bajt</div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div class=single-column-drawer-container ref=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item" href=/about>About Me</a>
<a class="a-block drawer-menu-item" href=/>Archive</a></div></div></div><transition name=fade><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav ref=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div ref=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a ref=navTitle class=navbar-brand href=/>My Programming Escapades</a></div></nav><div class=single-column-header-container ref=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=/><div class=single-column-header-title>My Programming Escapades</div><div class=single-column-header-subtitle>Andraz Bajt</div></a><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only style="background-image:url('/')"><div class=post-title>Rename rebase with git<div class=post-meta><time itemprop=datePublished>2020-04-20</time></div></div></div><div class=post-body-wrapper><div class=post-body><p>Want to perform a <code>git rebase</code> in which you rename a file without pesky
conflicts?</p><p>tl;dr</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git filter-branch -f --tree-filter <span style=color:#e6db74>&#34;git mv ORIGINAL_FILE_NAME NEW_FILE_NAME || true&#34;</span> -- <span style=color:#66d9ef>$(</span>git merge-base origin/master HEAD<span style=color:#66d9ef>)</span>..HEAD
git rebase origin/master
</code></pre></div><p>Ever wanted to rename a file you created/modified in a pull request but also
wanted to keep the pristine history you worked hard for? Well tough luck you
can either push a new commit to rename it (and keep old commits with the old
file name) or resolve a bunch of pointless conflicts. There must be a better
way&mldr;</p><p>Turns out you can have your commit history and eat it too! You can tell the git
to go through your history and do the rename on each commit <em>and then</em> rebase.</p><p>Let&rsquo;s walk through the steps. First we need to figure out which commits are
affected. To start of we need to find what git calls a &ldquo;merge base&rdquo; - the
nearest common ancestor with the target branch. This is the point from which
commits will be considered by e.g. GitHub when you open a pull request.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git merge-base origin/master HEAD
</code></pre></div><p>Assuming the target repo is <code>origin</code> and the target branch is <code>master</code>. <code>hEAD</code>
just points to whatever is currently checked out this will give use the merge
base commit hash.</p><p>We get the full commit range with the <code>..</code> operator. We can put the merge-base
command into a subshell to build up our one-liner</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#66d9ef>$(</span>git merge-base origin/master HEAD<span style=color:#66d9ef>)</span>..HEAD
</code></pre></div><p><em>NONE</em> this is not valid bash but a git construct to be used in further parameters.</p><p>And here comes the main star - git command to rewrite history: <code>git filter-branch</code>. It has many options and modes - read the docs for more info, here we&rsquo;ll just focus on our use case.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git filter-branch -f --tree-filter <span style=color:#e6db74>&#34;git mv ORIGINAL_FILE_NAME NEW_FILE_NAME || true&#34;</span> -- <span style=color:#66d9ef>$(</span>git merge-base origin/master HEAD<span style=color:#66d9ef>)</span>..HEAD
</code></pre></div><p>Let&rsquo;s walk through each part.</p><ul><li><code>filter-branch</code> is a command that rewrites a given set of commits using given commands</li><li><code>-f</code> is a <em>force</em> so we don&rsquo;t need extra confirmations - feel free to skip this one</li><li><code>--tree-filter</code> - this tells git we want to rewrite <em>file trees</em> meaning it will
checkout each tree, run our command and commit it back (using something like and amend)</li><li><code>"git mv ORIGINAL_FILE_NAME NEW_FILE_NAME || true"</code> this is our rename command.
We use <code>git mv</code> instead of plain <code>mv</code> so the result gets added to index automatically.
We add <code>|| true</code> so the exit code is 0 even if the file is missing - great for working
with larger histories.</li><li><code>-- $(git merge-base origin/master HEAD)..HEAD</code> and here comes our commit range expression.
Mind the space after <code>--</code> - this is <code>filter-branch</code> syntax to separate commits from
everything else.</li></ul><p>Then wait a bit (yes <code>filter-branch</code> may be quite slow)&mldr;..And we&rsquo;re done.
Well, almost. Still need to do the actual rebase - thus far we&rsquo;ve only done the
rename.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git rebase origin/master
</code></pre></div><p>My original use case was rebasing migrations that use sequence numbers as file names - you run into conflicts whenever somebody else merges any migration. So I&rsquo;ve created an alias and put it into my <code>~/.gitconfig</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>alias<span style=color:#f92672>]</span>
  rebase-migration <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;!f() { git filter-branch -f --tree-filter \&#34;git mv migrations/</span>$1<span style=color:#e6db74>.sql migrations/</span>$2<span style=color:#e6db74>.sql || true\&#34; -- </span><span style=color:#66d9ef>$(</span>git merge-base $3 HEAD<span style=color:#66d9ef>)</span><span style=color:#e6db74>..HEAD; git rebase </span>$3<span style=color:#e6db74>; }; f&#34;</span>
</code></pre></div><p>Now I can simply run</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git rebase-migration <span style=color:#ae81ff>76</span> <span style=color:#ae81ff>77</span> origin/develop
</code></pre></div><hr width=100%><p style=color:#777>Last modified on 2020-04-20</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2020-06-07-linux-gaming/>Next<br>Surprising ease of gaming on Linux in 2020</a>
<a class=older-posts href=/posts/2020-01-15-hugo/>Previous<br>Moving to Hugo</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=single-column-footer>&copy;
2021
Andraz Bajt</div></div><script src=//js/journal.js></script></body></html>