<!doctype html><html><head><title>Trying out Okteto Cloud</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.01c37d732f853bf90329007dc6f0a25c67722dd47b7168f8907facb93414bd91.css media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons"></head><body><div id=app><div ref=sideContainer class=side-container><div class="a-block nav-head false"><div class=nav-title>Andraž Bajt's blog</div><div class=nav-subtitle></div><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div class=nav-link-list><a class="a-block nav-link-item" href=/about>About Me</a>
<a class="a-block nav-link-item" href=/>Archive</a></div><div class=nav-footer>&copy;
2021
Andraz Bajt</div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div class=single-column-drawer-container ref=drawer><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item" href=/about>About Me</a>
<a class="a-block drawer-menu-item" href=/>Archive</a></div></div></div><div class=single-column-header-container ref=pageHead><a href=/><div class=single-column-header-title>Andraž Bajt's blog</div></a><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only style="background-image:url('/')"><div class=post-title>Trying out Okteto Cloud<div class=post-meta><time itemprop=datePublished>2021-02-27</time>
<i class=material-icons>label</i>
<a href=/tags/trying-out>trying-out</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body><p>This is a part two of <a href=/posts/2021-02-22-trying-out-okteto-cli/>Trying out Okteto</a>.
I&rsquo;ll be trying out <a href=https://okteto.com/>okteto.com</a> - &ldquo;The Kubernetes development platform&rdquo;.</p><p>At a first glance it looks like a hosted kubernetes solution + the CLI tool I
already tested + some bells and whistles. Let&rsquo;s find out what those are.</p><h1 id=first-impressions>First impressions</h1><p>Login with github. Boom I&rsquo;m in, no extra sign up required. Big thumbs up.</p><p>Looks like I got a managed namespace with 8G ram, 4cpus and 5G storage. Quite
generous for a free plan.</p><p>There is a convenient link to <a href=https://okteto.com/docs/getting-started/index.html>Getting started</a>.</p><h1 id=getting-started>Getting started</h1><p>Apparently those bells and whistles include build and deploy
pipeline&mldr;.reminds me of Heroku :)</p><p>I&rsquo;ll deviate from the guide and will try to deploy my buffalo test app because
I actually want to dive deep and understand what&rsquo;s happening.</p><p>Let&rsquo;s have a look at <a href=https://github.com/okteto/movies/blob/master/okteto-pipeline.yml>okteto-pipeline.yml from the example</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>icon</span>: <span style=color:#ae81ff>https://apps.okteto.com/movies/icon.png</span>
<span style=color:#f92672>deploy</span>:
  - <span style=color:#ae81ff>okteto build -t okteto.dev/api:${OKTETO_GIT_COMMIT} api</span>
  - <span style=color:#ae81ff>okteto build -t okteto.dev/frontend:${OKTETO_GIT_COMMIT} frontend</span>
  - <span style=color:#ae81ff>helm upgrade --install movies chart --set tag=${OKTETO_GIT_COMMIT}</span>
<span style=color:#f92672>devs</span>:
  - <span style=color:#ae81ff>api/okteto.yml</span>
  - <span style=color:#ae81ff>frontend/okteto.yml</span>
</code></pre></div><p>Quite a bit going on here. Looking at <code>okteto build -h</code> localy it seems this
will build two Dockerfiles, push the images to okteto servers and then do a
helm upgrade. This implies we need a helm chart for out app. Oh look, there is a
<a href=https://github.com/okteto/movies/tree/master/chart>chart for the example app</a></p><p>Let&rsquo;s try to mimic this and see how for I can get.</p><h1 id=the-helm-digression>The helm digression</h1><p>I&rsquo;ll admit I was a bit intimidated at the prospect of packaging my app up with
help just to get up and running as I&rsquo;ve only created a chart once previously and
even that was not from scratch but with some tweaking. But&mldr;how hard can it be?</p><p>First I copied over my test app since I&rsquo;ll probably be making some changes. I
already have a Dockerfile, okteto.yaml and database deployment configs. I think I
should create a chart next so I can try to deploy the app.</p><p><code>Chart.yaml</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v2</span>
<span style=color:#f92672>name</span>: <span style=color:#ae81ff>tryingout</span>
<span style=color:#f92672>description</span>: <span style=color:#ae81ff>Trying out Buffalo on Kubernetes</span>
<span style=color:#f92672>type</span>: <span style=color:#ae81ff>application</span>
<span style=color:#f92672>version</span>: <span style=color:#ae81ff>0.1.0</span>
<span style=color:#f92672>appVersion</span>: <span style=color:#ae81ff>1.0.0</span>
</code></pre></div><p>Any my <code>values.yaml</code> (based of movies example)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>tag</span>: <span style=color:#ae81ff>dev</span>

<span style=color:#f92672>web</span>:
  <span style=color:#f92672>replicaCount</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>okteto.dev/web</span>
</code></pre></div><p>Copied over notes, helpers (with name replacement). Not it&rsquo;s time to get to
business with the actual templates. I&rsquo;ll just reuse my deployment for postgres
and just add in the labels (though I should be a stateful set if I was even half
serious).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>db</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>db</span>
    {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 4 }}</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>component</span>: <span style=color:#ae81ff>db</span>
      {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 6 }}</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>component</span>: <span style=color:#ae81ff>db</span>
        {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 8 }}</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>postgres</span>
        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres:13.1-alpine</span>
        <span style=color:#f92672>env</span>:
        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>POSTGRES_PASSWORD</span>
          <span style=color:#f92672>value</span>: <span style=color:#e6db74>&#34;postgres&#34;</span>
        <span style=color:#f92672>ports</span>:
        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>5432</span>
---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>db</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>db</span>
    {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 4 }}</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>db</span>
    {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 4 }}</span>
  <span style=color:#f92672>ports</span>:
    - <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>5432</span>
</code></pre></div><p>Any now for the meat and the potatoes - my web deployment. Should be pretty much the same as postgres, I just need to
grab the image from the values.</p><p><em>A word of warning:</em> there are errors here - I left them in intentionally so I can
document my full process. See the <a href=https://github.com/edofic/trying-out/tree/main/okteto/v2/chart>git
repo</a> for latest
versions (which you can actually apply).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
    {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 4 }}</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
      {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 6 }}</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
        {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 8 }}</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
        <span style=color:#f92672>image</span>: {{ <span style=color:#ae81ff>.Values.api.image }}:{{ .Values.tag }}</span>
        <span style=color:#f92672>ports</span>:
        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>3000</span>
---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
    {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 4 }}</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
    {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 4 }}</span>
  <span style=color:#f92672>ports</span>:
    - <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>3000</span>
</code></pre></div><p>An ingress may come in handy as well.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>extensions/v1beta1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Ingress</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: {{ <span style=color:#ae81ff>include &#34;tryingout.fullname&#34; . }}</span>
  <span style=color:#f92672>labels</span>:
    {{- <span style=color:#ae81ff>include &#34;tryingout.labels&#34; . | nindent 4 }}</span>
  <span style=color:#f92672>annotations</span>:
    <span style=color:#f92672>dev.okteto.com/generate-host</span>: <span style=color:#e6db74>&#34;true&#34;</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>rules</span>:
    - <span style=color:#f92672>http</span>:
        <span style=color:#f92672>paths</span>:
          - <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/</span>
            <span style=color:#f92672>backend</span>:
              <span style=color:#f92672>serviceName</span>: <span style=color:#ae81ff>web</span>
              <span style=color:#f92672>servicePort</span>: <span style=color:#ae81ff>3000</span>
</code></pre></div><p>And now tie it all together with a pipeline</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>deploy</span>:
  - <span style=color:#ae81ff>okteto build -t okteto.dev/web:${OKTETO_GIT_COMMIT} web</span>
  - <span style=color:#ae81ff>helm upgrade --install tryingout chart --set tag=${OKTETO_GIT_COMMIT}</span>
<span style=color:#f92672>devs</span>:
  - <span style=color:#ae81ff>web/okteto.yml</span>
</code></pre></div><p>Now how do I run this? :)</p><p>Let&rsquo;s read the docs again&mldr;.</p><pre><code> $ okteto namespace
Authentication required. Do you want to log into Okteto? [y/n]: y
What is the URL of your Okteto instance? [https://cloud.okteto.com]:
Authentication will continue in your default browser
You can also open a browser and navigate to the following address:
https://cloud.okteto.com/auth/authorization-code?...
 ✓  Logged in as edofic
 ✓  Updated context 'cloud_okteto_com' in '/home/andraz/.kube/config'
</code></pre><p>Got a browser window to authenticate and I was back in the shell, logged in. Smooth.</p><p>Now how do I deploy from the terminal? There are <a href=https://okteto.com/docs/cloud/deploy-from-terminal>some docs</a>.</p><pre><code> $ okteto pipeline deploy
  x  failed to analyze git repo: repository does not exist
</code></pre><p>I think this means it too want to be in the repo root. Time to switch gears,
I&rsquo;ll try running steps manually. So we have a build and a helm chart install to
do.</p><p>I&rsquo;ll event set up <code>OKTETO_GIT_COMMIT</code> env variable so I can directly copy paste
the commands.</p><pre><code> $ OKTETO_GIT_COMMIT=$(git rev-parse HEAD)
 $ okteto build -t okteto.dev/web:${OKTETO_GIT_COMMIT} web
 .... a lot of output ....
 ✓  Image 'okteto.dev/web:d9f4f4850cb3e2cbb8fa623e5de68ab8419df304' successfully pushed
</code></pre><p>Looks like this actually pushed my &ldquo;docker context&rdquo; to the cloud and then ran
something like <code>docker build</code> & <code>docker push</code> there. Nice.</p><p>Let&rsquo;s try deploying my chart.</p><pre><code> $ helm upgrade --install tryingout chart --set tag=${OKTETO_GIT_COMMIT}
 Release &quot;tryingout&quot; does not exist. Installing it now.
 Error: template: tryingout/templates/web.yaml:22:25: executing
 &quot;tryingout/templates/web.yaml&quot; at &lt;.Values.api.image&gt;: nil pointer evaluating
 interface {}.image
</code></pre><p>Time to debug my yamls :D</p><p>A quick look at the error message and my config: I did a stupid :) There is
<code>api.image</code> in the template but <code>web.image</code> in <code>values.yaml</code> - a copy paste
gone wrong. Let&rsquo;s fix the template.</p><p>relevant part</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
        <span style=color:#f92672>image</span>: {{ <span style=color:#ae81ff>.Values.web.image }}:{{ .Values.tag }}</span>
        <span style=color:#f92672>ports</span>:
        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>3000</span>
</code></pre></div><p>And try again</p><pre><code>
 $ helm upgrade --install tryingout chart --set tag=${OKTETO_GIT_COMMIT}
Release &quot;tryingout&quot; does not exist. Installing it now.
NAME: tryingout
LAST DEPLOYED: Mon Feb 15 16:37:14 2021
NAMESPACE: edofic
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
</code></pre><h1 id=some-success>Some success</h1><p>And somthing popped up in the UI (no refresh needed!)</p><p><img src=/images/okteto/1_my_chart.png alt="my chart installed"></p><p>I can see the status, I can destroy/redeploy&mldr;. How can I now try to open up
the app? I created an ingress so let&rsquo;s see if I can use it.</p><pre><code> $ kubectl get ingress
NAME        HOSTS                               ADDRESS        PORTS     AGE
tryingout   tryingout-edofic.cloud.okteto.net   35.238.195.0   80, 443   13m
</code></pre><p>Oh wow, that actually worked we got a domain provisioned. Opening up this
hostname gives my my error page - migrations haven&rsquo;t run yet.</p><p><img src=/images/okteto/2_error_migrations.png alt="migrations error"></p><p>I should probably do a helm post upgrade hook to run migrations&mldr;but I&rsquo;ll half
ass it and do it manually now since I&rsquo;m trying to focus on okteto instead.</p><p>Looking at buffalo generated Dockerfile to orient myself I came across this
helpful nugget</p><pre><code># Uncomment to run the binary in &quot;production&quot; mode:
# ENV GO_ENV=production
...
# Uncomment to run the migrations before running the binary:
# CMD /bin/app migrate; /bin/app
</code></pre><p>Let&rsquo;s try this to see if out app stands up, then actually uncomment this and
we&rsquo;re off to the races!</p><pre><code> $ kubectl exec -it  web-644d8d487f-gp9hq -- sh
/bin # export GO_ENV=production
/bin # /bin/app migrate
WARN[2021-02-15T15:59:59Z] Unless you set SESSION_SECRET env variable, your session storage is not protected!
[POP] 2021/02/15 15:59:59 warn - ignoring file .pop-tmp.md because it does not match the migration file pattern
[POP] 2021/02/15 16:00:00 info - 0.0901 seconds
2021/02/15 16:00:00 Failed to run migrations: Migrator: problem creating schema migrations: couldn't start a new transaction: could not create new transaction: failed to connect to `host=db user=postgres database=trying_out_production`: server error (FATAL: database &quot;trying_out_production&quot; does not exist (SQLSTATE 3D000))
</code></pre><p>Apparently we also need to create the database. Let&rsquo;s do it manually at first to
confirm.</p><pre><code> $ kubectl exec -it db-f9f647bd4-l9gf6 -- psql -U postgres
create databasepsql (13.1)
Type &quot;help&quot; for help.

postgres=# create database trying_out_production;
CREATE DATABASE
postgres=#
</code></pre><p>Then try to run migrations again.</p><pre><code>/bin # /bin/app migrate
WARN[2021-02-15T16:01:43Z] Unless you set SESSION_SECRET env variable, your session storage is not protected!
[POP] 2021/02/15 16:01:43 warn - ignoring file .pop-tmp.md because it does not match the migration file pattern
[POP] 2021/02/15 16:01:44 info - &gt; create_users
[POP] 2021/02/15 16:01:44 info - Successfully applied 1 migrations.
[POP] 2021/02/15 16:01:44 info - 0.2692 seconds
</code></pre><p>Let&rsquo;s enable this for our build by uncommennting lines in the dockerfile.
And do the build & helm upgrade dance again.</p><pre><code> $ OKTETO_GIT_COMMIT=$(git rev-parse HEAD)
 $ okteto build -t okteto.dev/web:${OKTETO_GIT_COMMIT} web
 .... a lot of output ....
 ✓  Image 'okteto.dev/web:88607af3ea6dd4e5ee631d77dee462c5cf82f344' successfully pushed
</code></pre><p>while this was building I looked up <a href=https://hub.docker.com/_/postgres>docs for my postgres
image</a> and found out I can automate the
database creation part by setting <code>POSTGRES_DB</code> env variable. So I&rsquo;ll update the
chart as well.</p><p>From chart/templates/postgres.yaml</p><pre><code>      containers:
      - name: postgres
        image: postgres:13.1-alpine
        env:
        - name: POSTGRES_PASSWORD
          value: &quot;postgres&quot;
        - name: POSTGRES_DB
          value: &quot;trying_out_production&quot;
        ports:
        - containerPort: 5432
</code></pre><p>I&rsquo;ll actually click destroy helm chart in the UI now to try it out and clean up
to see if everyting stands up from scratch.</p><pre><code>helm upgrade --install movies chart --set tag=${OKTETO_GIT_COMMIT}
</code></pre><p>And we have liftoff!</p><p><img src=/images/okteto/3_up_in_cloud.png alt="app is up"></p><p>Now I think my app is properly&mldr;.err&mldr;well enough packaged and I can actually
try out pipelines. I&rsquo;ll kill the helm chart once more so I can try the
automation now.</p><h1 id=trying-pipelines>Trying pipelines</h1><p>I&rsquo;ll start off by creating a new orphan branch and then copy over my files
(won&rsquo;t bother rewriting history).</p><pre><code> $ git checkout --orphan okteto-pipeline
Switched to a new branch 'okteto-pipeline'
 $ git reset .
 $ rm -rf *
 $ git checkout main -- ./okteto/v2
 $ mv okteto/v2/* ./
 $ rm -rf okteto
 $ git commit -am &quot;Initial pipeline commit&quot;
 ...
 $ git push -u origin HEAD
Enumerating objects: 78, done.
Counting objects: 100% (78/78), done.
Delta compression using up to 8 threads
Compressing objects: 100% (70/70), done.
Writing objects: 100% (78/78), 167.44 KiB | 1.86 MiB/s, done.
Total 78 (delta 2), reused 0 (delta 0), pack-reused 0
remote: Resolving deltas: 100% (2/2), done.
^[[Aremote:
remote: Create a pull request for 'okteto-pipeline' on GitHub by visiting:
remote:      https://github.com/edofic/trying-out/pull/new/okteto-pipeline
remote:
To github.com:edofic/trying-out.git
 * [new branch]      HEAD -&gt; okteto-pipeline
</code></pre><p>Time to set up the pipeline</p><p><img src=/images/okteto/4_empty_namespace.png alt="deploy ui"></p><p>UI is obvious enough&mldr;</p><p><img src=/images/okteto/5_deploy.png alt="deploy setup"></p><p>Not much to configure&mldr;</p><p><img src=/images/okteto/6_deploying.png alt=deploying></p><p>Looks like it&rsquo;s running the same process as I was locally just before,
promising.</p><p><img src=/images/okteto/7_deployed.png alt=deployed></p><p>Success!
And out app is up again :D</p><h1 id=development>Development</h1><p>Now let&rsquo;s try developing it! I did need to update my <code>web/okteto.yml</code> with the
new deployment name <code>web</code>.</p><pre><code> $ okteto up
 ✓  Development container activated
 ✓  Connected to your development container
 ✓  Files synchronized
    Namespace: edofic
    Name:      web
    Forward:   2345 -&gt; 2345
               3000 -&gt; 3000

root@web-67456fb97b-85xcj:/src#
</code></pre><p>Amazingly the UI picked this up too</p><p><img src=/images/okteto/8_in_development.png alt="in development"></p><p>Let&rsquo;s run a development version</p><pre><code>root@web-67456fb97b-85xcj:/src# buffalo dev
...downloading the world for the first time
...building the world for the first time
</code></pre><p>Meanwhile I checked the UI and I see I have some storage going on, these would
be my persistent work environments and go cache so I don&rsquo;t always need to
rebuild the world.</p><pre><code> $ kubectl get pvc
NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
okteto-web   Bound    pvc-ead3ab73-9d8f-4e52-8990-bbe6a6d5b897   2Gi        RWO            okteto         4m8s
</code></pre><p>meanwhile the world has been built&mldr;</p><pre><code>INFO[2021-02-15T17:29:21Z] Starting application at http://127.0.0.1:3000
INFO[2021-02-15T17:29:21Z] Starting Simple Background Worker
</code></pre><p>sigh&mldr;this won&rsquo;t work as we need to bind to external IP in order to be
available from the cluster. Quick google search points me at <a href=https://gobuffalo.io/en/docs/getting-started/config-vars>buffalo docs</a> on how to setup the host:</p><pre><code> $ ADDR=0.0.0.0 buffalo dev
</code></pre><p>And we&rsquo;re up! Of course I forgot to create my databases again.
Wait I minute, I do have a db I want to use. Let&rsquo;s edit <code>database.yaml</code> instead</p><pre><code>development:
  dialect: postgres
  database: trying_out_production
  user: postgres
  password: postgres
  host: db
  pool: 5
</code></pre><p>This is a bit nonsensical but I&rsquo;m just playing around. Note: I did the edit
locally and the file sync picked it up. Sweet.</p><pre><code> $ ADDR=0.0.0.0 buffalo dev
</code></pre><p>And I finally have my dev server, that&rsquo;s one time setup for you :)</p><p>Now let&rsquo;s do a silly edit. I&rsquo;ll change some text in <code>templates/users/index.plush.html</code> `</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html>&lt;<span style=color:#f92672>h3</span> <span style=color:#a6e22e>class</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;d-inline-block&#34;</span>&gt;My Users&lt;/<span style=color:#f92672>h3</span>&gt;
</code></pre></div><p>File sync picked this up, synced, then dev server picked up and reloaded templates. By the time I switched from my editor to the browser and refreshed it was there. :o</p><p>Now let&rsquo;s save this.</p><pre><code> $ okteto down
 ✓  Development container deactivated
 i  Run 'okteto push' to deploy your code changes to the cluster
</code></pre><p>And we reverted back to the deployed image now. Let&rsquo;s try this suggested <code>okteto push</code></p><pre><code> $ okteto push
 ... build commences
</code></pre><p>This apparently pushed my context again, build the image remotely and updated my deployment live. Interesting. Let&rsquo;s try the pipeline way as well. I&rsquo;ll do another silly change and push just my commits to see what happens.</p><pre><code>  ... my edit
 $ git commit -am &quot;New text change&quot;
[okteto-pipeline 99b7f64] New text change
 1 file changed, 1 insertion(+), 1 deletion(-)
 $ git push
 ...
</code></pre><p>Nothing happened for 2min (maybe I&rsquo;m just too inpatient) so I&rsquo;ve hit redeploy in the UI. Did the trick - my changes are live. Much more quickly that with <code>okteto push</code></p><h1 id=charts>Charts</h1><p>Once more nice thing: you can deploy some helm charts from a catalog straight form the UI.</p><p><img src=/images/okteto/9_deploy_charts.png alt=charts></p><h1 id=conclusion>Conclusion</h1><p>In case this wasn&rsquo;t clear from my other remarks and commands I&rsquo;ve ran: okteto
gave my a fully fledged managed kubernetes namespace - this way I was able to
run my standard kubectl and helm commands.</p><p>All in all the CLI toool impresses me most. But Okteto Cloud is very nice as
well if you want a single opionionated full stack. You can cobble together
something similar for an existing cluster as well but it will require quite some
work and may have rough edges. (e.g. jenkins + argo cd + harbor registry)</p><hr width=100%><p style=color:#777>Last modified on 2021-02-27</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2021-04-14-trying-out-rancher/>Next<br>Trying out Rancher</a>
<a class=older-posts href=/posts/2021-02-22-trying-out-okteto-cli/>Previous<br>Trying out Okteto (CLI)</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=single-column-footer>&copy;
2021
Andraz Bajt</div></div></body></html>