<!DOCTYPE html>
<html><head>
<title>Making a programming language Part 5 - variables and decisions</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>



<link rel="stylesheet" href="/scss/journal.min.9d1b3d6c4f3ff1773fff9bdca1bc24452f33129e12f67f2ab14f2ddaf1603468.css" media="screen">

<script src="/js/loadCSS.js"></script>
<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>

</head>
<body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    <div class="a-block nav-head false">
        <div class="nav-title">
            My Programming Escapades
        </div>
        <div class="nav-subtitle">
            
                Andraz Bajt
            
        </div>
            
                <a href="https://github.com/edofic"><img src="/icons/github.svg" width="20"/></a>
            
            
                <a href="https://www.linkedin.com/in/edofic"><img src="/icons/linkedin.svg" width="20"/></a>
            
            
                <a href="https://twitter.com/edofic"><img src="/icons/twitter.svg" width="20"/></a>
            
            <a href="/index.xml"><img src="/icons/rss.svg" width="20"/></a>
            
                <a href="mailto:edofic@edofic.com"><img src="/icons/email.svg" width="20"/></a>
            
    </div>


    <div class="nav-link-list">
        
        
            
            
            <a class="a-block nav-link-item" href="/about">
                About Me
            </a>
        
            
            
            <a class="a-block nav-link-item" href="/">
                Archive
            </a>
        
    </div>

    <div class="nav-footer">
        &copy;
    2020
	
	Andraz Bajt
	

    </div>

</div>
<div ref="extraContainer" class="extra-container">
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
        
        
            
                
                
                <a class="a-block drawer-menu-item" href="/about">
                    About Me
                </a>
        
            
                
                
                    
                
                <a class="a-block drawer-menu-item" href="/">
                    Archive
                </a>
        
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="/">
            My Programming Escapades
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
        <a href="/">
            <div class="single-column-header-title">My Programming Escapades</div>
            
            <div class="single-column-header-subtitle">Andraz Bajt</div>
            
        </a>

        
            <a href="https://github.com/edofic"><img src="/icons/github.svg" width="20"/></a>
        
        
            <a href="https://www.linkedin.com/in/edofic"><img src="/icons/linkedin.svg" width="20"/></a>
        
        
            <a href="https://twitter.com/edofic"><img src="/icons/twitter.svg" width="20"/></a>
        
        <a href="/index.xml"><img src="/icons/rss.svg" width="20"/></a>
        
            <a href="mailto:edofic@edofic.com"><img src="/icons/email.svg" width="20"/></a>
        

</div>

            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                 style="background-image: url('/')">
                <div class="post-title">
                    Making a programming language Part 5 - variables and decisions
                    <div class="post-meta">
                        
                            <time itemprop="datePublished">
                                2012-09-02
                            </time>
                        

                        

                        
                    </div>
                </div>
            </div>

            <div class="post-body-wrapper">
                <div class="post-body">
                    <p><a href="http://commons.wikipedia.org/wiki/File%3AStdstreams-notitle.svg"><img src="http://upload.wikimedia.org/wikipedia/commons/thumb/7/70/Stdstreams-notitle.svg/300px-Stdstreams-notitle.svg.png" alt="A typical text terminal produces input and dis&hellip;"></a></p>
<p><a href="/posts/2012-08-29-creating-a-language-1">Table of contents</a>, 
<a href="https://github.com/edofic/scrat-lang">Whole project on github</a></p>
<p>In <a href="/posts/2012-09-01-creating-a-language4">Part 4</a> I
managed to create a <a href="http://en.wikipedia.org/wiki/Hello_world_program" title="Hello world program">Hello World</a>.
What's the next program after this in every programming tutorial? A
program that asks your name and greets you. Greeter perhaps?</p>
<p>Reading from <a href="http://en.wikipedia.org/wiki/Standard_streams" title="Standard streams">standard
input</a>
in pretty trivial, just wrapping up readLine
<a href="http://en.wikipedia.org/wiki/Function_%28mathematics%29" title="Function (mathematics)">function</a>
from scala, see previous post on how this is done. And I called this
function readln.</p>
<h3 id="variables">Variables</h3>
<p>I could cheat a bit and write something like this</p>
<pre><code>println(&quot;who are you?&quot;)
println(&quot;hello&quot;, readln())
</code></pre>
<p>since I don't really have to store the name. This works but I also want
to make a program that responds differently to different input, e.g.
simplified authentication. So I want to store the input. Something like</p>
<pre><code>print(&quot;enter passcode&quot;)
input = readln()
</code></pre>
<p>So I first create a case class to represent this</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Assignment</span><span style="color:#f92672">(</span>to<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Identifier</span><span style="color:#f92672">,</span> from<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Expression</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Expression</span>
</code></pre></div><p>parsing isn't that hard either</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> assignment<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Parser</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Assignment</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>
  identifier <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;=&#34;</span> <span style="color:#f92672">~</span> expr <span style="color:#f92672">^^</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">case</span> id <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;=&#34;</span> <span style="color:#f92672">~</span> exp <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Assignment</span><span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> exp<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> expr<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Parser</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Expression</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> sum <span style="color:#f92672">|||</span> assignment
</code></pre></div><p>Notice again my abuse of <code>|||</code> where reverse order would have sufficed,
don't do that.</p>
<p>Evaluation&hellip;here I had to make a choice. Where to put the assigned
variables. In the same bucket as constants. <a href="http://en.wikipedia.org/wiki/Global_variable" title="Global variable">Global
variables</a>
ARE evil but I don't care since I'm having fun and I do it anyway. Don't
worry this changes when I introduce function definitions and objects.</p>
<p>So StdLib became ScratRuntime and has a mutable map for storing values
of identifiers. Full source
<a href="https://github.com/edofic/scrat-lang/blob/51008205be59ec325dcb1de2f1058071c1703f4a/main/src/com/edofic/scrat/Runtime.scala">here</a> if you're interested. Of course some changes had to be made because of this
refactoring. Full commit
diff <a href="https://github.com/edofic/scrat-lang/commit/51008205be59ec325dcb1de2f1058071c1703f4a">here</a>.</p>
<p>Evaluation of assignment is now simple map put</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">Assignment</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> exp<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">val</span> e <span style="color:#66d9ef">=</span> apply<span style="color:#f92672">(</span>exp<span style="color:#f92672">)</span>
  runtime<span style="color:#f92672">.</span>identifiers<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span>name<span style="color:#f92672">.</span>id<span style="color:#f92672">,</span> e<span style="color:#f92672">)</span>
  e
<span style="color:#f92672">}</span>
</code></pre></div><p>The expression returns the assigned value so you can do a=b=1(in fact I
didn't try that yet)</p>
<h3 id="what-if">What if</h3>
<p>If expressions. I wasn't in the mood for parentheses or brackets so I
went ruby style. Except my expressions are single line only(for now) so
I had to put everything in one line. I needed a separator between the
<a href="http://en.wikipedia.org/wiki/Predicate_%28grammar%29" title="Predicate (grammar)">predicate</a>
and positive value and as an added bonus I didn't need the &ldquo;end&rdquo;. So not
much like ruby anymore but it was good inspiration. </p>
<p>I considered booleans but ultimately I can implement everything still in
doubles(too much work to make  whole <a href="http://en.wikipedia.org/wiki/Type_system" title="Type system">type
system</a> of
primitives when you can have just one type). Zero is False and
everything else is True. So AND becomes <code>*</code> and OR becomes <code>-</code>. I'll add
some equality so I can compare strings too.</p>
<p>I didn't need inequalities until now(didn't even think about before
writing this post) so they aren't in the language yet.</p>
<p>Sample if expression</p>
<p>if input1*input2 then &ldquo;okay&rdquo; else &ldquo;nooooooo&rdquo;</p>
<p>See, no parens. And I was inspired by scala to make the else part
mandatory.</p>
<p>So how do I implement this? Case class is quite trivial, it has tree
expressions: predicate, true value and false value. Evaluation just
evaluates the predicate(recursion!!) and then evaluates and returns the
appropriate expression</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">IfThenElse</span><span style="color:#f92672">(</span>pred<span style="color:#f92672">,</span> then<span style="color:#f92672">,</span> els<span style="color:#f92672">)</span> <span style="color:#66d9ef">=&gt;</span>
  apply<span style="color:#f92672">(</span>pred<span style="color:#f92672">)</span> <span style="color:#66d9ef">match</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">case</span> d<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Double</span> <span style="color:#f92672">=&gt;</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>d <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> apply<span style="color:#f92672">(</span>then<span style="color:#f92672">)</span> <span style="color:#66d9ef">else</span> apply<span style="color:#f92672">(</span>els<span style="color:#f92672">)</span>
    <span style="color:#66d9ef">case</span> other <span style="color:#66d9ef">=&gt;</span>
      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ScratInvalidTypeError</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;expected a number, got &#34;</span> <span style="color:#f92672">+</span> other<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>That error is just a class that extends exception.
I added some more case classes and evaluation cases for Equals and
NotEquals. They're very simple so I won't include them here(<a href="https://github.com/edofic/scrat-lang/commit/97312113282b484fa53357f61fb05990da0cd3ea">diff on
github</a>)
Parsing on the other hand is more interesting, here's the changed part.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> ifThenElse<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Parser</span><span style="color:#f92672">[</span><span style="color:#66d9ef">IfThenElse</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>
  <span style="color:#e6db74">&#34;if&#34;</span> <span style="color:#f92672">~</span> expr <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;then&#34;</span> <span style="color:#f92672">~</span> expr <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;else&#34;</span> <span style="color:#f92672">~</span> expr <span style="color:#f92672">^^</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;if&#34;</span> <span style="color:#f92672">~</span> predicate <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;then&#34;</span> <span style="color:#f92672">~</span> then <span style="color:#f92672">~</span> <span style="color:#e6db74">&#34;else&#34;</span> <span style="color:#f92672">~</span> els <span style="color:#66d9ef">=&gt;</span>
      <span style="color:#a6e22e">IfThenElse</span><span style="color:#f92672">(</span>predicate<span style="color:#f92672">,</span> then<span style="color:#f92672">,</span> els<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> equality<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Parser</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Expression</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>
  noEqExpr <span style="color:#f92672">~</span> rep<span style="color:#f92672">(</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;==&#34;</span> <span style="color:#f92672">|</span> <span style="color:#e6db74">&#34;!=&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">~</span> noEqExpr<span style="color:#f92672">)</span> <span style="color:#f92672">^^</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">case</span> head <span style="color:#f92672">~</span> tail <span style="color:#66d9ef">=&gt;</span>
      <span style="color:#66d9ef">var</span> tree<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Expression</span> <span style="color:#f92672">=</span> head
      tail<span style="color:#f92672">.</span>foreach <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;==&#34;</span> <span style="color:#f92672">~</span> e <span style="color:#66d9ef">=&gt;</span> tree <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">Equals</span><span style="color:#f92672">(</span>tree<span style="color:#f92672">,</span> e<span style="color:#f92672">)</span>
        <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;!=&#34;</span> <span style="color:#f92672">~</span> e <span style="color:#66d9ef">=&gt;</span> tree <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">NotEquals</span><span style="color:#f92672">(</span>tree<span style="color:#f92672">,</span> e<span style="color:#f92672">)</span>
      <span style="color:#f92672">}</span>
      tree
  <span style="color:#f92672">}</span>
<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> noEqExpr<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Parser</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Expression</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span>
  sum <span style="color:#f92672">|||</span> assignment <span style="color:#f92672">|||</span> ifThenElseprivate <span style="color:#66d9ef">def</span> expr <span style="color:#66d9ef">=</span> noEqExpr <span style="color:#f92672">|||</span> equality
</code></pre></div><p><a href="http://www.flickr.com/photos/90863480@N00/4947839133"><img src="http://farm5.static.flickr.com/4074/4947839133_086f0266e4_m.jpg" alt="layers"></a></p>
<p>I finally got around to understand grammars a bit more. In order to make
the grammar not ambiguous an not left recursive you stack layers upon
layers. Like onion.  And you use these layers to separate layers of
precedence - most lightly binding operations being the upper
layer(expr). This gets rid of ambiguity. And you can also use these
layers to deal with recursion. Something in a deeper layer can contain
an item from a higher layer - thus recursion - but it must first match
something to avoid infinite recursion. And that's it. This is very well
explained on <a href="https://www.coursera.org/compilers">compilers course on Coursera</a> 
and I thought I understood the (very abstract) explanation but the evidence says
I did not until I had some hands on experience.</p>
<p>A quick sample in scrat to finish it of</p>
<pre><code>print(&quot;enter passcode&quot;)
pass = &quot;password&quot;
state = if readln()==pass then &quot;granted&quot; else &quot;denied&quot;
println(&quot;access&quot;, state)
</code></pre>
<p><strong>next <a href="/posts/2012-09-25-creating-a-language-6">implementing user defined functions</a></strong></p>

                    <HR width="100%">
                    
                    <p style="color:#777;">Last modified on 2012-09-02</p>
                    
                </div>

            </div>


            <nav class="post-pagination">

                
                <a class="newer-posts" href="/posts/2012-09-17-composition/">
                    Next<br>Pretty function composition in scala and asynchronous function composition on android
                </a>
                

                
                <a class="older-posts" href="/posts/2012-09-01-creating-a-language4/">
                    Previous<br>Making a programming language Part 4 - Hello World
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                



            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">&copy;
    2020
	
	Andraz Bajt
	
</div>
    	</div>
    <script src="//js/journal.js"></script>
    </body>
</html>
