<!doctype html><html><head><title>Dockerless Services (with Nix)</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.01c37d732f853bf90329007dc6f0a25c67722dd47b7168f8907facb93414bd91.css media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons"></head><body><div id=app><div ref=sideContainer class=side-container><div class="a-block nav-head false"><div class=nav-title>My Programming Escapades</div><div class=nav-subtitle>Andraz Bajt</div><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div class=nav-link-list><a class="a-block nav-link-item" href=/about>About Me</a>
<a class="a-block nav-link-item" href=/>Archive</a></div><div class=nav-footer>&copy;
2021
Andraz Bajt</div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div class=single-column-drawer-container ref=drawer><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item" href=/about>About Me</a>
<a class="a-block drawer-menu-item" href=/>Archive</a></div></div></div><div class=single-column-header-container ref=pageHead><a href=/><div class=single-column-header-title>My Programming Escapades</div><div class=single-column-header-subtitle>Andraz Bajt</div></a><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only style="background-image:url('/')"><div class=post-title>Dockerless Services (with Nix)<div class=post-meta><time itemprop=datePublished>2017-08-30</time></div></div></div><div class=post-body-wrapper><div class=post-body><p>So you want an &ldquo;isolated&rdquo; MySQL &ldquo;service&rdquo; but don&rsquo;t want to (or are not able
to) run Docker/rkt/LXC/whatever?</p><p>Here are the tl;dr steps:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd /tmp
mkdir mysql-1
cd mysql-1
nix-shell -p mysql
mysql_install_db --datadir<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>
mysqld --datadir<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span> --socket<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/socket &amp;
mysqladmin -uroot -h127.0.0.1 password &lt;REDACTED&gt;
mysql -uroot -p&lt;REDACTED&gt; -h127.0.0.1
...
</code></pre></div><h2 id=why>Why?</h2><p>My motivation for this was running a database on a machine with a specially
tuned kernel that did not support containers.</p><h2 id=how-it-works>How it works?</h2><p>Create a new folder to host all data for your service</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cd /tmp
mkdir mysql-1
cd mysql-1
</code></pre></div><p>Get the binary somewehere. I use <a href=https://nixos.org/nix/>Nix</a> due to its pure
stateless nature - it allows me to have different conlicting versions on my
system without any container magic.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nix-shell -p mysql
</code></pre></div><p>Initialize the data structure. Mind the <code>--datadir</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysql_install_db --datadir<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>
</code></pre></div><p>Launch the server. If you want to run multiple instances you also need to
specify a port number with <code>--port</code> here. Socket is also placed in the datadir
so the init does not try to pullute in <code>/run</code></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysqld --datadir<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span> --socket<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/socket &amp;
</code></pre></div><p>Finish configuration and use. Need to provide the IP here since UNIX socket is
on a non-standard place.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysqladmin -uroot -h127.0.0.1 password &lt;REDACTED&gt;
mysql -uroot -p&lt;REDACTED&gt; -h127.0.0.1
</code></pre></div><p>You can now stop with</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mysqladmin -uroot -p&lt;REDACTED&gt; -h127.0.0.1 shutdown
</code></pre></div><h2 id=going-faster>Going faster</h2><p>You can mount <code>tmpfs</code> for your datadir to make MySQL go really fast. <strong>Note</strong>
your data is not persisted to your harddrive anymore - use with caution.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir mysql-1
mount -t tmpfs none mysql-1
cd mysql-1
...
</code></pre></div><p>Creating an in-memory filesystem is <a href=https://www.tekrevue.com/tip/how-to-create-a-4gbs-ram-disk-in-mac-os-x/>slightly more
involved</a>
for MacOS users but still not too bad.</p><h2 id=automate-all-the-things>Automate all the things</h2><p>With the assumption that we want to store data under <code>/tmp</code> and that <code>/tmp</code> is
already <code>tmpfs</code> we can fully automate the script above:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#! /usr/bin/env bash
</span><span style=color:#75715e></span>set -e
PORT<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>1<span style=color:#66d9ef>:-</span>3306<span style=color:#e6db74>}</span>
cd <span style=color:#66d9ef>$(</span>mktemp -d<span style=color:#66d9ef>)</span>
mysql_install_db --datadir<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>
mysqld --datadir<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span> --socket<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/socket --port<span style=color:#f92672>=</span>$PORT &amp;
sleep <span style=color:#ae81ff>3</span>
mysqladmin -uroot -h127.0.0.1 password root
</code></pre></div><p>Or even make it self-contained and pull in the right MySQL as well</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#! /usr/bin/env nix-shell
</span><span style=color:#75715e></span><span style=color:#75715e>#! nix-shell -i bash -p mysql55</span>
set -e
PORT<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>1<span style=color:#66d9ef>:-</span>3306<span style=color:#e6db74>}</span>
cd <span style=color:#66d9ef>$(</span>mktemp -d<span style=color:#66d9ef>)</span>
mysql_install_db --datadir<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>
mysqld --datadir<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span> --socket<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pwd<span style=color:#66d9ef>)</span>/socket --port<span style=color:#f92672>=</span>$PORT &amp;
sleep <span style=color:#ae81ff>3</span>

mysqladmin -uroot -h127.0.0.1 password root
</code></pre></div><hr width=100%><p style=color:#777>Last modified on 2017-08-30</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2017-09-01-scala-tuple-apply/>Next<br>Implementing apply on tuples in Scala</a>
<a class=older-posts href=/posts/2016-09-21-toy-sized-tdd/>Previous<br>TDD-ing a toy sized project</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=single-column-footer>&copy;
2021
Andraz Bajt</div></div></body></html>