<!doctype html><html><head><title>Trying out Prometheus</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.01c37d732f853bf90329007dc6f0a25c67722dd47b7168f8907facb93414bd91.css media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons"></head><body><div id=app><div ref=sideContainer class=side-container><div class="a-block nav-head false"><div class=nav-title>My Programming Escapades</div><div class=nav-subtitle>Andraz Bajt</div><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div class=nav-link-list><a class="a-block nav-link-item" href=/about>About Me</a>
<a class="a-block nav-link-item" href=/>Archive</a></div><div class=nav-footer>&copy;
2021
Andraz Bajt</div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div class=single-column-drawer-container ref=drawer><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item" href=/about>About Me</a>
<a class="a-block drawer-menu-item" href=/>Archive</a></div></div></div><div class=single-column-header-container ref=pageHead><a href=/><div class=single-column-header-title>My Programming Escapades</div><div class=single-column-header-subtitle>Andraz Bajt</div></a><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only style="background-image:url('/')"><div class=post-title>Trying out Prometheus<div class=post-meta><time itemprop=datePublished>2021-06-27</time>
<i class=material-icons>label</i>
<a href=/tags/trying-out>trying-out</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body><p>This time I&rsquo;m trying out a monitoring solution: <a href=https://prometheus.io/>Prometheus</a>.</p><p>All I know about it so far:</p><ul><li>pull based, server scrapes /metrics on workloads, human readable format</li><li>scales well because of this</li><li>popular in kuberetes space</li></ul><p>Let&rsquo;s try running the <a href=https://hub.docker.com/r/prom/prometheus/>docker iamge</a>
based on the README.</p><pre><code>docker run --rm -it -p9090:9090 prom/prometheus:main
</code></pre><p><img src=/images/prometheus/1.png alt="prometheus dashboard"></p><p>We&rsquo;ve got lift off! And it&rsquo;s monitoring itself right out the gate:</p><p><img src=/images/prometheus/2.png alt="prometheus monitoring itself"></p><h1 id=docker-compose>docker-compose</h1><p>I want to add more services now and I don&rsquo;t want to fiddle with <code>docker run</code> so
time for a compose file.</p><p>Consulting with <a href=https://prometheus.io/docs/prometheus/latest/installation/>the docs</a> I managed this</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3.7&#39;</span>
<span style=color:#f92672>volumes</span>:
    <span style=color:#f92672>prometheus_data</span>:
    <span style=color:#f92672>grafana_data</span>:
<span style=color:#f92672>services</span>:
  <span style=color:#f92672>prometheus</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>prom/prometheus:v2.28.0</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>./prometheus_config/:/etc/prometheus/</span>
      - <span style=color:#ae81ff>prometheus_data:/prometheus</span>
    <span style=color:#f92672>command</span>:
      - <span style=color:#e6db74>&#39;--config.file=/etc/prometheus/prometheus.yml&#39;</span>
      - <span style=color:#e6db74>&#39;--storage.tsdb.path=/prometheus&#39;</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#ae81ff>9090</span>:<span style=color:#ae81ff>9090</span>
  <span style=color:#f92672>grafana</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/grafana:8.0.3</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#ae81ff>3000</span>:<span style=color:#ae81ff>3000</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>grafana_data:/var/lib/grafana</span>
</code></pre></div><p>Yes I threw in a Grafana instance as well.</p><p>I based <code>prometheus_config/prometheus.yml</code> of of <a href=https://prometheus.io/docs/prometheus/latest/getting_started/>getting started</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>global</span>:
  <span style=color:#f92672>scrape_interval</span>:     <span style=color:#ae81ff>15s</span> <span style=color:#75715e># By default, scrape targets every 15 seconds.</span>

<span style=color:#f92672>scrape_configs</span>:
  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;prometheus&#39;</span>
    <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5s</span>
    <span style=color:#f92672>static_configs</span>:
      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:9090&#39;</span>]
</code></pre></div><p>Running <code>docker-compose up -d</code> and we&rsquo;re off to the races.
<code>http://localhost:9090</code> gives the same interface (but now with persistent
storage) but there is now Grafana as well (on port 3000)</p><p><img src=/images/prometheus/3.png alt=img></p><p>And it can easily be configured to point to the Prometheus instance.</p><p><img src=/images/prometheus/5.png alt=img></p><p>Yaay, metrics in Grafana.</p><p><img src=/images/prometheus/6.png alt=img></p><h1 id=my-app>My app</h1><p>For the next step I want to run my own app and have Prometheus scrape it. To get
started I add <a href=https://github.com/mitranim/gow>gow</a>-based service to my compose
file to have a development friendly environment with auto-recompilation.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  <span style=color:#f92672>app</span>:
    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>golang:1.16-alpine</span>
    <span style=color:#f92672>volumes</span>:
      - <span style=color:#ae81ff>go:/go</span>
      - <span style=color:#ae81ff>./app:/go/src/app</span>
    <span style=color:#f92672>working_dir</span>: <span style=color:#ae81ff>/go/src/app</span>
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>go run github.com/mitranim/gow run .</span>
    <span style=color:#f92672>ports</span>:
      - <span style=color:#ae81ff>2112</span>:<span style=color:#ae81ff>2112</span>
</code></pre></div><p>And run with <code>docker-compose up app</code></p><p>Init the app with <code>go mod init app</code> and get something up based on the example
from the docs: <a href=https://prometheus.io/docs/guides/go-application/>https://prometheus.io/docs/guides/go-application/</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;log&#34;</span>
	<span style=color:#e6db74>&#34;net/http&#34;</span>

	<span style=color:#e6db74>&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;:2112&#34;</span>
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting server on&#34;</span>, <span style=color:#a6e22e>addr</span>)
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/metrics&#34;</span>, <span style=color:#a6e22e>promhttp</span>.<span style=color:#a6e22e>Handler</span>())
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#a6e22e>addr</span>, <span style=color:#66d9ef>nil</span>)
}
</code></pre></div><p>I can now curl for metrics from my laptop:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh> $ curl -s http://localhost:2112/metrics | head -n5
 <span style=color:#75715e># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.</span>
 <span style=color:#75715e># TYPE go_gc_duration_seconds summary</span>
 go_gc_duration_seconds<span style=color:#f92672>{</span>quantile<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>0</span>
 go_gc_duration_seconds<span style=color:#f92672>{</span>quantile<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.25&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>0</span>
 go_gc_duration_seconds<span style=color:#f92672>{</span>quantile<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;0.5&#34;</span><span style=color:#f92672>}</span> <span style=color:#ae81ff>0</span>
</code></pre></div><p>Great. Now I only need to inform Prometheus about the existence of my app.</p><p>Back to <a href=https://prometheus.io/docs/prometheus/latest/getting_started/>getting started</a>
to configure scraping:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;app&#39;</span>
    <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5s</span>
    <span style=color:#f92672>static_configs</span>:
      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;app:2112&#39;</span>]
</code></pre></div><p>Apparently SIGHUP to reload config should do the trick</p><pre><code>dc logs -f prometheus
</code></pre><p>And in another window</p><pre><code> $ dc kill -s SIGHUP prometheus
Killing prometheus_prometheus_1 ... done
</code></pre><p>Apparently it worked</p><pre><code>prometheus_1  | level=info ts=2021-06-27T09:05:57.511Z caller=main.go:964 msg=&quot;Loading configuration file&quot; filename=/etc/prometheus/prometheus.yml
prometheus_1  | level=info ts=2021-06-27T09:05:57.511Z caller=main.go:995 msg=&quot;Completed loading of configuration file&quot; filename=/etc/prometheus/prometheus.yml totalDuration=645.968µs remote_storage=2.492µs web_handler=602ns query_engine=1.266µs scrape=120.724µs scrape_sd=82.519µs notify=1.101µs notify_sd=1.398µs rules=1.343µs
</code></pre><p>and now &ldquo;app&rdquo; shows up in metrics in Grafana!</p><p><img src=/images/prometheus/7.png alt=img></p><h1 id=request-counter>Request counter</h1><p>This is still only showing preconfigured metrics. How do I do my custom metrics?
e.g. a request counter.</p><p>Based on the <a href=https://prometheus.io/docs/guides/go-application/>same Go docs</a> I
put this together</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>

<span style=color:#f92672>import</span> (
	<span style=color:#e6db74>&#34;log&#34;</span>
	<span style=color:#e6db74>&#34;net/http&#34;</span>

	<span style=color:#e6db74>&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
	<span style=color:#e6db74>&#34;github.com/prometheus/client_golang/prometheus/promauto&#34;</span>
	<span style=color:#e6db74>&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
)

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
	<span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>&#34;:2112&#34;</span>
	<span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Starting server on&#34;</span>, <span style=color:#a6e22e>addr</span>)
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/metrics&#34;</span>, <span style=color:#a6e22e>promhttp</span>.<span style=color:#a6e22e>Handler</span>())
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handle</span>(<span style=color:#e6db74>&#34;/&#34;</span>, <span style=color:#a6e22e>newHandleReq</span>())
	<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ListenAndServe</span>(<span style=color:#a6e22e>addr</span>, <span style=color:#66d9ef>nil</span>)
}

<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>handleReq</span> <span style=color:#66d9ef>struct</span> {
	<span style=color:#a6e22e>reqCounter</span> <span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>Counter</span>
}

<span style=color:#66d9ef>func</span> <span style=color:#a6e22e>newHandleReq</span>() <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Handler</span> {
	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>handleReq</span>{
		<span style=color:#a6e22e>reqCounter</span>: <span style=color:#a6e22e>promauto</span>.<span style=color:#a6e22e>NewCounter</span>(<span style=color:#a6e22e>prometheus</span>.<span style=color:#a6e22e>CounterOpts</span>{
			<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;app_req_counter&#34;</span>,
			<span style=color:#a6e22e>Help</span>: <span style=color:#e6db74>&#34;The total number of processed requests&#34;</span>,
		}),
	}
}

<span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>h</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>handleReq</span>) <span style=color:#a6e22e>ServeHTTP</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
	<span style=color:#a6e22e>h</span>.<span style=color:#a6e22e>reqCounter</span>.<span style=color:#a6e22e>Inc</span>()
	<span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#e6db74>&#34;ok\n&#34;</span>))
}
</code></pre></div><p>gow picks up changes, and my curl requests do indeed show up in Grafana.</p><p><img src=/images/prometheus/8.png alt=img></p><h1 id=kuberetes>Kuberetes</h1><p>Now how do I get this running in kubernetes? :D How does this work in context of
pods? Is there some autodetection of scraping targets?</p><p>First of all I need a fresh cluster. This time in
<a href=https://minikube.sigs.k8s.io/docs/>minikube</a></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ minikube start
$ eval <span style=color:#66d9ef>$(</span>minikube docker-env<span style=color:#66d9ef>)</span>
</code></pre></div><p>Google quickly finds <a href=https://github.com/prometheus-community/helm-charts/tree/main/charts/prometheus>helm
charts</a></p><p>Let&rsquo;s try it out</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
$ helm repo update
$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</code></pre></div><p>then</p><pre><code>minikube dashboard
</code></pre><p>and wait for all green
<img src=/images/prometheus/9.png alt=img></p><pre><code> $ k get service
NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
kubernetes                         ClusterIP   10.96.0.1        &lt;none&gt;        443/TCP    11m
my-prometheus-alertmanager         ClusterIP   10.110.118.230   &lt;none&gt;        80/TCP     4m45s
my-prometheus-kube-state-metrics   ClusterIP   10.102.204.67    &lt;none&gt;        8080/TCP   4m45s
my-prometheus-node-exporter        ClusterIP   None             &lt;none&gt;        9100/TCP   4m45s
my-prometheus-pushgateway          ClusterIP   10.100.67.158    &lt;none&gt;        9091/TCP   4m45s
my-prometheus-server               ClusterIP   10.104.36.146    &lt;none&gt;        80/TCP     4m45s
</code></pre><p>The chart includes services as well, let&rsquo;s use port forwarding to access it</p><pre><code> $ k port-forward service/my-prometheus-server 9090:80
Forwarding from 127.0.0.1:9090 -&gt; 9090
Forwarding from [::1]:9090 -&gt; 9090
</code></pre><p>And the regular UI is available again on <code>localhost:9090</code></p><p>Let&rsquo;s do Grafana as well</p><pre><code>$ helm repo add grafana https://grafana.github.io/helm-charts
$ helm install my-grafana grafana/grafana
NAME: my-grafana
LAST DEPLOYED: Sun Jun 27 13:37:33 2021
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get your 'admin' user password by running:

   kubectl get secret --namespace default my-grafana -o jsonpath=&quot;{.data.admin-password}&quot; | base64 --decode ; echo

2. The Grafana server can be accessed via port 80 on the following DNS name from within your cluster:

   my-grafana.default.svc.cluster.local

   Get the Grafana URL to visit by running these commands in the same shell:

     export POD_NAME=$(kubectl get pods --namespace default -l &quot;app.kubernetes.io/name=grafana,app.kubernetes.io/instance=my-grafana&quot; -o jsonpath=&quot;{.items[0].metadata.name}&quot;)
     kubectl --namespace default port-forward $POD_NAME 3000

3. Login with the password from step 1 and the username: admin
#################################################################################
######   WARNING: Persistence is disabled!!! You will lose your data when   #####
######            the Grafana pod is terminated.                            #####
#################################################################################
</code></pre><p>Following instructions (but forwading the sirevice directly)</p><pre><code>kubectl get secret --namespace default my-grafana -o jsonpath=&quot;{.data.admin-password}&quot; | base64 --decode ; echo
k port-forward service/my-grafana 3000:80
</code></pre><h2 id=packaging-the-app>Packaging the app</h2><p>Time to package up my app</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:1.16-alpine as builder</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . /src<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /src</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go build .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> alpine</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /bin/</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /src/app .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 2112</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> /bin/app<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>and build (inside minikube&rsquo;s docker daemon!)</p><pre><code>docker build . -t app:latest
</code></pre><p>k8s manifests are the usual boilerplate</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>app:latest</span>
        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Never</span> <span style=color:#75715e># side-load via minikube</span>
        <span style=color:#f92672>ports</span>:
        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>2112</span>
---
<span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
  <span style=color:#f92672>ports</span>:
    - <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
      <span style=color:#f92672>port</span>: <span style=color:#ae81ff>2112</span>
</code></pre></div><p>and apply</p><pre><code>k apply -f ./app.yaml
</code></pre><p>forward it too</p><pre><code>k port-forward service/web 2112
</code></pre><p>Now I can call it from my laptop</p><pre><code> $ curl http://localhost:2112/
ok
</code></pre><p>now how do I get this into prometheus?</p><h2 id=scraping-in-k8s>Scraping in k8s</h2><p>After quite a bit of stumped googling I checked out
<a href=https://github.com/prometheus-community/helm-charts/blob/29765f2377bb48e0b3a80a980a865c23bc60c74b/charts/prometheus/values.yaml#L1471-L1481>values.yaml</a>
of the char I applied and found this explanation</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># Scrape config for service endpoints.</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># The relabeling allows the actual service scrape endpoint to be configured</span>
<span style=color:#75715e># via the following annotations:</span>
<span style=color:#75715e>#</span>
<span style=color:#75715e># * `prometheus.io/scrape`: Only scrape services that have a value of `true`</span>
<span style=color:#75715e># * `prometheus.io/scheme`: If the metrics endpoint is secured then you will need</span>
<span style=color:#75715e># to set this to `https` &amp; most likely set the `tls_config` of the scrape config.</span>
<span style=color:#75715e># * `prometheus.io/path`: If the metrics path is not `/metrics` override this.</span>
<span style=color:#75715e># * `prometheus.io/port`: If the metrics are exposed on a different port to the</span>
<span style=color:#75715e># service then set this appropriately.</span>
</code></pre></div><p>So I figured to add <code>prometheus.io/scrape</code> to my manifests. But where? Service
or pod spec? I Prometheus should scrape pods in my case since I want to get
counter values per-pod.</p><p>Updated deployment:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>component</span>: <span style=color:#ae81ff>web</span>
      <span style=color:#f92672>annotations</span>:
        <span style=color:#f92672>prometheus.io/scrape</span>: <span style=color:#e6db74>&#34;true&#34;</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>web</span>
        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>app:latest</span>
        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Never</span> <span style=color:#75715e># side-load via minikube</span>
        <span style=color:#f92672>ports</span>:
        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>2112</span>
</code></pre></div><p>My pod is picked up on <code>localhost:9090/targets</code>, great success.</p><p><img src=/images/prometheus/11.png alt=img></p><p>Naturally metrics also show up in Grafana</p><p><img src=/images/prometheus/10.png alt=img></p><p>Killing pods/scaling deployment is nicely visible in metrics now.</p><p><img src=/images/prometheus/12.png alt=img></p><h1 id=conclusion>Conclusion</h1><p>Setting up Prometheus was actually quite straightforward. So is configuring the
actual scraping. Application codebase doesn&rsquo;t need to know anything about my
infrastructure, no configuration needed - it simply exposes a <code>/metrics/</code>
endpoint. Then scraping is enabled in my deployment manifest.</p><p>For me the part that actually needs some getting used to is the query language,
but I think the infrastructure niceties are well worth it.</p><hr width=100%><p style=color:#777>Last modified on 2021-06-27</p></div></div><nav class=post-pagination><a class=newer-posts>Next<br>No newer posts.</a>
<a class=older-posts href=/posts/2021-04-15-trying-microk8s/>Previous<br>Trying out Microk8s</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=single-column-footer>&copy;
2021
Andraz Bajt</div></div></body></html>