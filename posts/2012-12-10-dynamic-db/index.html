<!doctype html><html><head><title>Cool Monday - Exploration of dynamic db acces from scala</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.01c37d732f853bf90329007dc6f0a25c67722dd47b7168f8907facb93414bd91.css media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons"></head><body><div id=app><div ref=sideContainer class=side-container><div class="a-block nav-head false"><div class=nav-title>My Programming Escapades</div><div class=nav-subtitle>Andraz Bajt</div><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div class=nav-link-list><a class="a-block nav-link-item" href=/about>About Me</a>
<a class="a-block nav-link-item" href=/>Archive</a></div><div class=nav-footer>&copy;
2021
Andraz Bajt</div></div><div ref=extraContainer class=extra-container><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div class=single-column-drawer-container ref=drawer><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item" href=/about>About Me</a>
<a class="a-block drawer-menu-item" href=/>Archive</a></div></div></div><div class=single-column-header-container ref=pageHead><a href=/><div class=single-column-header-title>My Programming Escapades</div><div class=single-column-header-subtitle>Andraz Bajt</div></a><a href=https://github.com/edofic><img src=/icons/github.svg width=20></a>
<a href=https://www.linkedin.com/in/edofic><img src=/icons/linkedin.svg width=20></a>
<a href=https://twitter.com/edofic><img src=/icons/twitter.svg width=20></a>
<a href=/index.xml><img src=/icons/rss.svg width=20></a>
<a href=mailto:edofic@edofic.com><img src=/icons/email.svg width=20></a></div><div id=content><div ref=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only style="background-image:url('/')"><div class=post-title>Cool Monday - Exploration of dynamic db acces from scala<div class=post-meta><time itemprop=datePublished>2012-12-10</time></div></div></div><div class=post-body-wrapper><div class=post-body><p>I use <a href=http://www.scala-lang.org/ title="Scala (programming language)">scala</a> on
<a href="http://www.t-mobile.com/shop/phones/?capcode=AGE" title="Android phones">Android</a>
and I don&rsquo;t like the integrated database
<a href=http://en.wikipedia.org/wiki/Application_programming_interface title="Application programming interface">API</a>.
It&rsquo;s very verbose and very stateful. I had written my own
<a href=http://en.wikipedia.org/wiki/Object-relational_mapping title="Object-relational mapping">ORM</a>(<a href=http://en.wikipedia.org/wiki/Data_access_object title="Data access object">DAO</a>
would be a more appropriate tag) a while back, before I used scala but
it&rsquo;s not enough anymore. So now I&rsquo;m on a quest for a better database
API. My dream is something small that handles schema for me and is
<a href=http://en.wikipedia.org/wiki/Type_safety title="Type safety">type-safe</a>. A
nice
<a href=http://en.wikipedia.org/wiki/Digital_subscriber_line title="Digital subscriber line">DSL</a>
that is converted to
<a href="http://www.iso.org/iso/catalogue_detail.htm?csnumber=45498" title=SQL>SQL</a>
at <a href=http://en.wikipedia.org/wiki/Compile_time title="Compile time">compile
time</a>  and
does code generation. So it&rsquo;s fast like hand writing everything. But
reduces code footprint by an order of magnitude(at least).
<a href=http://www.scala-lang.org/ title="Scala (programming language)">Scala</a>
<a href=http://slick.typesafe.com/>SLICK</a> looks promising. It fits most
requirements. But it&rsquo;s kinda big for android projects(you need scala
library too!) and has not yet hit a stable version so I wouldn&rsquo;t be
comfortable shipping it. Will definitely give it a thorough test when
scala 2.10 is stable and SLICK is released. Oh, and it needs a third
party <a href=http://en.wikipedia.org/wiki/JDBC_driver title="JDBC driver">JDBC
 driver</a> for
Android. This is another level of abstraction and therefore another
source of slowness. I contemplated writing my own clone targeted at
Android but   never came around to actually doing it(yet!). It seems
like a herculean task for single developer working in spare time.</p><h3 id=meanwhile>Meanwhile</h3><p>Yesterday I stared thinking how <a href=http://en.wikipedia.org/wiki/Dynamic_programming_language title="Dynamic programming language">dynamic
languages</a>
handle databases. And I got an idea. Scala has type Dynamic that does
compilation magic to provide syntactic sugar for working with dynamic
languages or objects. Here&rsquo;s an idea: do queries in plain SQL and
perform extraction of data in a dynamic way. </p><p>And how to do this? Just wrap up Cursor to provide necessary methods. </p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WrappedCursor</span><span style=color:#f92672>(</span>cursor<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Cursor</span><span style=color:#f92672>)</span> implements <span style=color:#a6e22e>Cursor</span><span style=color:#f92672>{</span>  <span style=color:#75715e>//delegated methods go here}
</span></code></pre></div><p>Why I need this? Cake pattern of course, Dynamic cursor get&rsquo;s mixed in.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>DynamicCursor</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Dynamic</span><span style=color:#f92672>{</span> <span style=color:#66d9ef>this:</span> <span style=color:#66d9ef>Cursor</span> <span style=color:#f92672>=&gt;</span>
    <span style=color:#66d9ef>def</span> selectDynamic<span style=color:#f92672>(</span>name<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>String</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> getColumn<span style=color:#f92672>(</span>getColumnIndex<span style=color:#f92672>(</span>name<span style=color:#f92672>))</span>
    <span style=color:#66d9ef>def</span> getColumn<span style=color:#f92672>(</span>index<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Int</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> getType<span style=color:#f92672>(</span>index<span style=color:#f92672>)</span> <span style=color:#66d9ef>match</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Cursor</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FIELD_TYPE_BLOB</span> <span style=color:#66d9ef>=&gt;</span> getBlob<span style=color:#f92672>(</span>index<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Cursor</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FIELD_TYPE_FLOAT</span> <span style=color:#66d9ef>=&gt;</span> getDouble<span style=color:#f92672>(</span>index<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Cursor</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FIELD_TYPE_INTEGER</span> <span style=color:#66d9ef>=&gt;</span> getLong<span style=color:#f92672>(</span>index<span style=color:#f92672>)</span>
        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Cursor</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FIELD_TYPE_NULL</span> <span style=color:#66d9ef>=&gt;</span> <span style=color:#66d9ef>null</span>
        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>Cursor</span><span style=color:#f92672>.</span><span style=color:#a6e22e>FIELD_TYPE_STRING</span> <span style=color:#66d9ef>=&gt;</span> getString<span style=color:#f92672>(</span>index<span style=color:#f92672>)</span>
    <span style=color:#f92672>}</span>
    <span style=color:#66d9ef>def</span> toSeq <span style=color:#66d9ef>=</span> <span style=color:#f92672>(</span><span style=color:#ae81ff>0</span> until getColumnCount<span style=color:#f92672>)</span> map getColumn
<span style=color:#f92672>}</span>

</code></pre></div><p>I targeted API level 14(Ice Cream Sandwich) since getType(method on
Cursor) is available from 11 on.    Key method here is getColumn that
abstracts over types. So you can read a column and  do pattern matching
on it. Or you are evil and use implicit conversions from Any to String,
Long etc&mldr; Or use implicit conversion to &ldquo;converter&rdquo;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Converter</span><span style=color:#f92672>(</span><span style=color:#66d9ef>val</span> value<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Any</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span><span style=color:#f92672>{</span>
    <span style=color:#66d9ef>def</span> blob <span style=color:#66d9ef>=</span> value<span style=color:#f92672>.</span>asInstanceOf<span style=color:#f92672>[</span><span style=color:#66d9ef>Array</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Byte</span><span style=color:#f92672>]]</span>
    <span style=color:#66d9ef>def</span> double <span style=color:#66d9ef>=</span> value<span style=color:#f92672>.</span>asInstanceOf<span style=color:#f92672>[</span><span style=color:#66d9ef>Double</span><span style=color:#f92672>]</span>
    <span style=color:#66d9ef>def</span> long <span style=color:#66d9ef>=</span> value<span style=color:#f92672>.</span>asInstanceOf<span style=color:#f92672>[</span><span style=color:#66d9ef>Long</span><span style=color:#f92672>]</span>
    <span style=color:#66d9ef>def</span> string <span style=color:#66d9ef>=</span> value<span style=color:#f92672>.</span>asInstanceOf<span style=color:#f92672>[</span><span style=color:#66d9ef>String</span><span style=color:#f92672>]</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>But the real deal is selectDynamic. This allows you to write code like
this</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>val</span> c <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WrappedCursor</span><span style=color:#f92672>(</span>result<span style=color:#f92672>)</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>DynamicCursorc</span><span style=color:#f92672>.</span>someColumn<span style=color:#f92672>.</span>long
</code></pre></div><p>This compiles down to selectDynamic(&ldquo;someColumn&rdquo;) that calls getColumn
and finally implicit conversion is inserted that allows for terse cast
to Long.
And I threw in a conversion from row to Seq that does a snapshot of
current row. This allows pattern matching on rows. Any you can now
construct a Stream that will handle Cursor state and lazily evaluate and
store these snapshots. Therefore you can abstract away all mutability
and handle cursor as immutable collection.</p><p>Said conversion to stream</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>CursorStream</span><span style=color:#f92672>(</span>cursor<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>DynamicCursorRaw</span> <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>Cursor</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>def</span> loop<span style=color:#f92672>()</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Stream</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Seq</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Any</span><span style=color:#f92672>]]</span> <span style=color:#66d9ef>=</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>if</span><span style=color:#f92672>(</span>cursor<span style=color:#f92672>.</span>isAfterLast<span style=color:#f92672>)</span>
            <span style=color:#a6e22e>Stream</span><span style=color:#f92672>.</span>empty<span style=color:#f92672>[</span><span style=color:#66d9ef>Seq</span><span style=color:#f92672>[</span><span style=color:#66d9ef>Any</span><span style=color:#f92672>]]</span>
        <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>val</span> snapshot <span style=color:#66d9ef>=</span> cursor<span style=color:#f92672>.</span>toSeq
            cursor<span style=color:#f92672>.</span>moveToNext<span style=color:#f92672>()</span>
            snapshot <span style=color:#f92672>#</span><span style=color:#66d9ef>:</span><span style=color:#66d9ef>:</span> <span style=color:#66d9ef>loop</span><span style=color:#f92672>()</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>
    cursor<span style=color:#f92672>.</span>moveToFirst<span style=color:#f92672>()</span>
    loop<span style=color:#f92672>()</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>And some more implicits to help</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RichCursorRaw</span><span style=color:#f92672>(</span>cursor<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Cursor</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span><span style=color:#f92672>{</span>
    <span style=color:#66d9ef>def</span> dynamicRaw <span style=color:#66d9ef>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WrappedCursor</span><span style=color:#f92672>(</span>cursor<span style=color:#f92672>)</span> <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>DynamicCursorRaw</span>
    <span style=color:#66d9ef>def</span> toStream <span style=color:#66d9ef>=</span> <span style=color:#a6e22e>CursorStream</span><span style=color:#f92672>(</span>dynamicRaw<span style=color:#f92672>)</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>All the source is in the project on
github <a href=https://github.com/edofic/dynamic-db-android>https://github.com/edofic/dynamic-db-android</a> (work
in progress).</p><hr width=100%><p style=color:#777>Last modified on 2012-12-10</p></div></div><nav class=post-pagination><a class=newer-posts href=/posts/2013-01-27-union-types/>Next<br>Union types in scala</a>
<a class=older-posts href=/posts/2012-12-04-hw-functional/>Previous<br>Homework - functional style (outer sorting)</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=single-column-footer>&copy;
2021
Andraz Bajt</div></div></body></html>