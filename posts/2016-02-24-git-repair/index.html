<!doctype html><html><head><title>Repairing a corrupt Git repo using a clone</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><style>body{max-width:800px;margin:auto;line-height:1.6;font-size:18px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}.nav a,.nav a:visited,.nav a:hover,.nav a:active{color:inherit}.nav .title{margin:0}.nav-sub{display:inline-block}.nav-item{margin:5px}.nav-sub-right{display:inline-block;float:right}.nav-icon{margin-right:5px}.main img{display:block;max-width:100%;margin:auto}.main pre{overflow:auto}" media="screen"></style></head><body><div class=nav><a href=/><h2 class=title>Andra≈æ Bajt's blog</h2></a><div class=nav-sub><a class=nav-item href=/about>About Me</a>
<a class=nav-item href=/>Archive</a></div><div class=nav-sub-right><a class=nav-icon href=https://github.com/edofic target=_blank><img src=/icons/github.svg width=20 height=20></a>
<a class=nav-icon href=https://www.linkedin.com/in/edofic target=_blank><img src=/icons/linkedin.svg width=20 height=20></a>
<a class=nav-icon href=https://twitter.com/edofic target=_blank><img src=/icons/twitter.svg width=20 height=20></a>
<a class=nav-icon href=/index.xml target=_blank><img src=/icons/rss.svg width=20 height=20></a>
<a class=nav-icon href=mailto:blog@edofic.com target=_blank><img src=/icons/email.svg width=20 height=20></a></div></div><hr><div class=main><h1>Repairing a corrupt Git repo using a clone</h1><time>2016-02-24</time><hr><p>Quite recently I managed to make myself a corrupt git repository due to a file system failure.
See, git stores everything in content addressable blobs - the file name of something is it&rsquo;s hash. Which lends itself nicely to checking repository integrity - it keeps out malicious attackers as well as my file system problems.</p><p>I already hear you saying: Why not just make a new clone, git is distributed anyway?
Well, I wasn&rsquo;t diligent enough to push everything. I had local commits that were quite important, so I spent some time fixing it.</p><h2 id=fsck>fsck</h2><p>Git has a command to manually check integrity of the repository: <code>git fsck</code>.
Running it lists all the errors.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash> $ git fsck
error: garbage at end of loose object <span style=color:#e6db74>&#39;3ce5b3af5d47179ff31a665ff267e1c7b6e4d8aa&#39;</span>
fatal: loose object 3ce5b3af5d47179ff31a665ff267e1c7b6e4d8aa <span style=color:#f92672>(</span>stored in .git/objects/3c/e5b3af5d47179ff31a665ff267e1c7b6e4d8aa<span style=color:#f92672>)</span> is corrupt
</code></pre></td></tr></table></div></div><p>Luckily in my case the list was quite short so I went ahead and deleted all the objects that were listed as corrupted. So now my objects are fine, but I&rsquo;m missing some. Luckily (again) corrupted objects did not contain any data pertaining to unpushed commits so I thought I can use a close to restore them.</p><h2 id=unpack>unpack</h2><p>So I lied a bit, git doesn&rsquo;t store every blob in a separate file, that would become huge pretty quickly. Instead it uses <strong>packfiles</strong>. It packs several blobs into one file and does delta compression to reduce disk usage. So I cannot just copy over blobs from a clone.</p><p>Fortunately git has commands for dealing with packfiles as well. The one of interest is <code>git unpack-file</code> which takes a packfile, extracts all the blobs and dumps them into the repo. Potentially producing loose objects, but let&rsquo;s not care about that for a second.</p><p>So I made a bare clone from github</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>git clone --bare git@github.com/edofic/blog
</code></pre></td></tr></table></div></div><p>And just unpacked everything</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>cd ~/actual-blog-repo
git unpack-file &lt; /tmp/blog.git/objects/pack/*.pack
</code></pre></td></tr></table></div></div><p>And it worked! <code>git fsck</code> did not complain anymore. Well at least not about garbage and corruption - just loose objects.</p><p>But that is easy to clean up: just prune them</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>git prune --expire now
</code></pre></td></tr></table></div></div><p>And do a GC to re-compress.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash>git gc
</code></pre></td></tr></table></div></div><p>Any my repo integrity is back!</p><hr><p>Last modified on 2016-02-24</p><a href=/posts/2015-05-03-unary-numbers/>Previous Lazy unary numbers</a><br><a href=/posts/2016-09-21-toy-sized-tdd/>Next TDD-ing a toy sized project</a></div></body></html>