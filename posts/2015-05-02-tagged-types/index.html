<!DOCTYPE html>
<html><head>
<title>Cheap tagged types in Scala</title>

<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">




<script src="/vendor/js/jquery.min.js" ></script>
<script src="/vendor/js/popper.min.js" ></script>
<script src="/vendor/js/bootstrap.min.js" ></script>
<script src="/vendor/js/smooth-scroll.polyfills.min.js" ></script>
<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">
<script src="/vendor/js/vue.min.js" ></script>



<link rel="stylesheet" href="/scss/journal.min.9d1b3d6c4f3ff1773fff9bdca1bc24452f33129e12f67f2ab14f2ddaf1603468.css" media="screen">

<script src="/js/loadCSS.js"></script>
<script>
    loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons");
</script>

</head>
<body>
    	<div id="app"><div ref="sideContainer" class="side-container">
    <div class="a-block nav-head false">
        <div class="nav-title">
            My Programming Escapades
        </div>
        <div class="nav-subtitle">
            
                Andraz Bajt
            
        </div>
            
                <a href="https://github.com/edofic"><img src="/icons/github.svg" width="20"/></a>
            
            
                <a href="https://www.linkedin.com/in/edofic"><img src="/icons/linkedin.svg" width="20"/></a>
            
            
                <a href="https://twitter.com/edofic"><img src="/icons/twitter.svg" width="20"/></a>
            
            
            
                <a href="mailto:edofic@edofic.com"><img src="/icons/email.svg" width="20"/></a>
            
    </div>


    <div class="nav-link-list">
        
        
            
            
            <a class="a-block nav-link-item" href="/about">
                About Me
            </a>
        
            
            
            <a class="a-block nav-link-item" href="/">
                Archive
            </a>
        
    </div>

    <div class="nav-footer">
        &copy;
    2020
	
	Andraz Bajt
	

    </div>

</div>
<div ref="extraContainer" class="extra-container">
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
    </div>
</div><div class="single-column-drawer-container" ref="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
        
        
            
                
                
                <a class="a-block drawer-menu-item" href="/about">
                    About Me
                </a>
        
            
                
                
                    
                
                <a class="a-block drawer-menu-item" href="/">
                    Archive
                </a>
        
        </div>
    </div>
</div>
<transition name="fade">
    <div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div ref="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a ref="navTitle" class="navbar-brand" href="/">
            My Programming Escapades
        </a>
    </div>
</nav>
<div class="single-column-header-container" ref="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
        <a href="/">
            <div class="single-column-header-title">My Programming Escapades</div>
            
            <div class="single-column-header-subtitle">Andraz Bajt</div>
            
        </a>

        
            <a href="https://github.com/edofic"><img src="/icons/github.svg" width="20"/></a>
        
        
            <a href="https://www.linkedin.com/in/edofic"><img src="/icons/linkedin.svg" width="20"/></a>
        
        
            <a href="https://twitter.com/edofic"><img src="/icons/twitter.svg" width="20"/></a>
        
        
        
            <a href="mailto:edofic@edofic.com"><img src="/icons/email.svg" width="20"/></a>
        

</div>

            <div id="content">
<div ref="streamContainer" class="stream-container">
    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                 style="background-image: url('/')">
                <div class="post-title">
                    Cheap tagged types in Scala
                    <div class="post-meta">
                        
                            <time itemprop="datePublished">
                                2015-05-02
                            </time>
                        

                        

                        
                    </div>
                </div>
            </div>

            <div class="post-body-wrapper">
                <div class="post-body">
                    <p>Sometimes you want to distinguish between different types that have the same underlying representation. For example both <code>UserId</code> and <code>ProductId</code> could be represented by <code>Long</code>. The usual solution is to introduce wrappers in order to make the distinction safe.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserId</span><span style="color:#f92672">(</span>id<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProductId</span><span style="color:#f92672">(</span>id<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">)</span>
</code></pre></div><p>But this introduces runtime overhead of boxing and unboxing over and over which may add up in some cases. Luckily Scala 2.10 introduced value classes. We can ensure no runtime overhead by extending <code>AnyVal</code> (this can only be done with classes with one field).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserId</span><span style="color:#f92672">(</span>id<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AnyVal</span>
<span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProductId</span><span style="color:#f92672">(</span>id<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AnyVal</span>
</code></pre></div><h3 id="inheritance">Inheritance</h3>
<p>Let's say that we also want a general <code>Id</code> type</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">case</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Id</span><span style="color:#f92672">(</span>id<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">Long</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AnyVal</span>
</code></pre></div><p>So far so good. But we cannot make a value class extend this <code>Id</code>! <a href="http://docs.scala-lang.org/overviews/core/value-classes.html">A value class may only extend universal traits</a>. This means we could define a trait that represents the notion of <code>Id</code> but we could not make it into a concrete type with values. And even more problems occur when we want to play around with variance. What now?</p>
<h3 id="tagging-with-types">Tagging with types</h3>
<p>A possible solution is to define an &ldquo;empty&rdquo; higher order type and store tags into type parameters.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">trait</span> <span style="color:#a6e22e">Tagged</span><span style="color:#f92672">[</span><span style="color:#66d9ef">+</span><span style="color:#66d9ef">V</span>, <span style="color:#66d9ef">+</span><span style="color:#66d9ef">T</span><span style="color:#f92672">]</span>
<span style="color:#a6e22e">type</span> <span style="color:#f92672">@@</span><span style="color:#f92672">[</span><span style="color:#66d9ef">+</span><span style="color:#66d9ef">V</span>, <span style="color:#66d9ef">+</span><span style="color:#66d9ef">T</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> V <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Tagged</span><span style="color:#f92672">[</span><span style="color:#66d9ef">V</span>, <span style="color:#66d9ef">T</span><span style="color:#f92672">]</span>

</code></pre></div><p><code>@@</code> represents a union of two types so values of type <code>@@[V,T]</code> will be equal to values of <code>V</code> at runtime (as <code>T</code> is empty) but we have access to <code>T</code> at compile time.</p>
<p>We can also write a simple implicit class helper for easy tagging</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Taggable</span><span style="color:#f92672">[</span><span style="color:#66d9ef">V</span><span style="color:#f92672">]</span><span style="color:#f92672">(</span><span style="color:#66d9ef">val</span> value<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">V</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AnyVal</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">def</span> tag<span style="color:#f92672">[</span><span style="color:#66d9ef">T</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> value<span style="color:#f92672">.</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">V</span> <span style="color:#66d9ef">@@</span> <span style="color:#66d9ef">T</span><span style="color:#f92672">]</span>
  <span style="color:#66d9ef">def</span> tagAs<span style="color:#f92672">[</span><span style="color:#66d9ef">T</span> <span style="color:#66d9ef">&lt;:</span> <span style="color:#66d9ef">V</span> <span style="color:#66d9ef">@@</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> value<span style="color:#f92672">.</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">T</span><span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>We create values simply by casting as the runtime representation will stay the same.</p>
<p>Usage may look like</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">trait</span> <span style="color:#a6e22e">TId</span>
<span style="color:#66d9ef">trait</span> <span style="color:#a6e22e">TUser</span>

<span style="color:#66d9ef">type</span> <span style="color:#66d9ef">Id</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Long</span> <span style="color:#f92672">@@</span> <span style="color:#a6e22e">TId</span>
<span style="color:#66d9ef">type</span> <span style="color:#66d9ef">UserId</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Long</span> <span style="color:#f92672">@@</span> <span style="color:#a6e22e">TUser</span>

<span style="color:#ae81ff">1234.</span>tag<span style="color:#f92672">[</span><span style="color:#66d9ef">TUser</span><span style="color:#f92672">]</span> <span style="color:#75715e">// inferred type: Long @@ TUser
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5678.</span>tagAs<span style="color:#f92672">[</span><span style="color:#66d9ef">UserId</span><span style="color:#f92672">]</span>
</code></pre></div><p>A good thing about this approach is that unboxing is automatical since <code>V &lt;:&lt; @@[V,T]</code>. But sometimes you may want to untag your values in order to pass them somewhere where you don't want to keep the tags. For this we just need a function that uses the automatic unboxing</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Untaggable</span><span style="color:#f92672">[</span><span style="color:#66d9ef">V</span>, <span style="color:#66d9ef">T</span><span style="color:#f92672">]</span><span style="color:#f92672">(</span><span style="color:#66d9ef">val</span> tagged<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">V</span> <span style="color:#66d9ef">with</span> <span style="color:#66d9ef">Tagged</span><span style="color:#f92672">[</span><span style="color:#66d9ef">V</span>, <span style="color:#66d9ef">T</span><span style="color:#f92672">]</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AnyVal</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">def</span> untag<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">V</span> <span style="color:#f92672">=</span> tagged
<span style="color:#f92672">}</span>
</code></pre></div><p>The trick is just to &ldquo;pattern match&rdquo; on the type we implicitly convert.</p>
<h3 id="collections">Collections</h3>
<p>Sometimes you want to tag a collection of something. You could <code>xs.map(_.tag[Foo])</code> but this would actually create a new collection at runtime. We can get away just with casting (thus in constant time)!. Notice that collections are nothing special, we may just as well cast a json printer instead of creating a wrapper.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-scala" data-lang="scala"><span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TaggableM</span><span style="color:#f92672">[</span><span style="color:#66d9ef">M</span><span style="color:#f92672">[</span><span style="color:#66d9ef">_</span><span style="color:#f92672">]</span>, <span style="color:#66d9ef">V</span><span style="color:#f92672">]</span><span style="color:#f92672">(</span><span style="color:#66d9ef">val</span> value<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">M</span><span style="color:#f92672">[</span><span style="color:#66d9ef">V</span><span style="color:#f92672">]</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AnyVal</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">def</span> tagM<span style="color:#f92672">[</span><span style="color:#66d9ef">T</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> value<span style="color:#f92672">.</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">M</span><span style="color:#f92672">[</span><span style="color:#66d9ef">V</span> <span style="color:#66d9ef">@@</span> <span style="color:#66d9ef">T</span><span style="color:#f92672">]</span><span style="color:#f92672">]</span>
  <span style="color:#66d9ef">def</span> tagAsM<span style="color:#f92672">[</span><span style="color:#66d9ef">T</span> <span style="color:#66d9ef">&lt;:</span> <span style="color:#66d9ef">V</span> <span style="color:#66d9ef">@@</span> <span style="color:#66d9ef">_</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> value<span style="color:#f92672">.</span>asInstanceOf<span style="color:#f92672">[</span><span style="color:#66d9ef">M</span><span style="color:#f92672">[</span><span style="color:#66d9ef">T</span><span style="color:#f92672">]</span><span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">implicit</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UntaggableM</span><span style="color:#f92672">[</span><span style="color:#66d9ef">M</span><span style="color:#f92672">[</span><span style="color:#66d9ef">+</span><span style="color:#66d9ef">_</span><span style="color:#f92672">]</span>, <span style="color:#66d9ef">V</span>, <span style="color:#66d9ef">T</span><span style="color:#f92672">]</span><span style="color:#f92672">(</span><span style="color:#66d9ef">val</span> tagged<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">M</span><span style="color:#f92672">[</span><span style="color:#66d9ef">V</span> <span style="color:#66d9ef">with</span> <span style="color:#66d9ef">Tagged</span><span style="color:#f92672">[</span><span style="color:#66d9ef">V</span>, <span style="color:#66d9ef">T</span><span style="color:#f92672">]</span><span style="color:#f92672">]</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AnyVal</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">def</span> untagM<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">M</span><span style="color:#f92672">[</span><span style="color:#66d9ef">V</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> tagged
<span style="color:#f92672">}</span>
</code></pre></div><p>This is an abstraction over any <code>M[_]</code>. You could write abstractions for other shapes but in practice I never needed anything other since this covers collections and most typeclass instances.</p>
<h3 id="variance">Variance</h3>
<p>An observant reader noticed I defined <code>@@</code> to be covariant in both arguments. You probably should leave the value type covariant since it is by nature covariant at runtime but you may change it to invariant if you want to &ldquo;disable&rdquo; automatic upcasting. However the tag type may also be contravariant although I found that covarinace is what you naturally expect and covers most cases. Sadly I haven't found a way to abstract over variance.</p>
<h3 id="disclaimer">Disclaimer</h3>
<p>I got this idea from ScalaZ but implemented it in my own way a while ago.</p>

                    <HR width="100%">
                    
                    <p style="color:#777;">Last modified on 2015-05-02</p>
                    
                </div>

            </div>


            <nav class="post-pagination">

                
                <a class="newer-posts" href="/posts/2015-05-03-unary-numbers/">
                    Next<br>Lazy unary numbers
                </a>
                

                
                <a class="older-posts" href="/posts/2014-10-05-haskell-apis/">
                    Previous<br>Approaches to designing a Haskell API
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                



            </div>
        </div>
    </div>
</div>

            </div><div id="single-column-footer">&copy;
    2020
	
	Andraz Bajt
	
</div>
    	</div>
    <script src="//js/journal.js"></script>
    </body>
</html>
