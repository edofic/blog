<!doctype html><html><head><title>Cheap tagged types in Scala</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><style>body{max-width:800px;margin:auto;line-height:1.6;font-size:18px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}.nav a,.nav a:visited,.nav a:hover,.nav a:active{color:inherit}.nav .title{margin:0}.nav-sub{display:inline-block}.nav-item{margin:5px}.nav-sub-right{display:inline-block;float:right}.nav-icon{margin-right:5px}.main img{display:block;max-width:100%;margin:auto}.main pre{overflow:auto}" media="screen"></style></head><body><div class=nav><a href=/><h2 class=title>Andra≈æ Bajt's blog</h2></a><div class=nav-sub><a class=nav-item href=/about/>About Me</a>
<a class=nav-item href=/>Archive</a></div><div class=nav-sub-right><a class=nav-icon href=https://github.com/edofic target=_blank><img src=/icons/github.svg width=20 height=20></a>
<a class=nav-icon href=https://www.linkedin.com/in/edofic target=_blank><img src=/icons/linkedin.svg width=20 height=20></a>
<a class=nav-icon href=https://twitter.com/edofic target=_blank><img src=/icons/twitter.svg width=20 height=20></a>
<a class=nav-icon href=/index.xml target=_blank><img src=/icons/rss.svg width=20 height=20></a>
<a class=nav-icon href=mailto:blog@edofic.com target=_blank><img src=/icons/email.svg width=20 height=20></a></div></div><hr><div class=main><h1>Cheap tagged types in Scala</h1><time>2015-05-02</time><hr><p>Sometimes you want to distinguish between different types that have the same underlying representation. For example both <code>UserId</code> and <code>ProductId</code> could be represented by <code>Long</code>. The usual solution is to introduce wrappers in order to make the distinction safe.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserId</span><span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductId</span><span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>)</span>
</span></span></code></pre></td></tr></table></div></div><p>But this introduces runtime overhead of boxing and unboxing over and over which may add up in some cases. Luckily Scala 2.10 introduced value classes. We can ensure no runtime overhead by extending <code>AnyVal</code> (this can only be done with classes with one field).</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserId</span><span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ProductId</span><span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=inheritance>Inheritance</h3><p>Let&rsquo;s say that we also want a general <code>Id</code> type</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>case</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Id</span><span style=color:#f92672>(</span>id<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>Long</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span>
</span></span></code></pre></td></tr></table></div></div><p>So far so good. But we cannot make a value class extend this <code>Id</code>! <a href=http://docs.scala-lang.org/overviews/core/value-classes.html>A value class may only extend universal traits</a>. This means we could define a trait that represents the notion of <code>Id</code> but we could not make it into a concrete type with values. And even more problems occur when we want to play around with variance. What now?</p><h3 id=tagging-with-types>Tagging with types</h3><p>A possible solution is to define an &ldquo;empty&rdquo; higher order type and store tags into type parameters.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>Tagged</span><span style=color:#f92672>[</span><span style=color:#66d9ef>+V</span>, <span style=color:#66d9ef>+T</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>type</span> <span style=color:#f92672>@@[</span><span style=color:#66d9ef>+V</span>, <span style=color:#66d9ef>+T</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> V <span style=color:#66d9ef>with</span> <span style=color:#a6e22e>Tagged</span><span style=color:#f92672>[</span><span style=color:#66d9ef>V</span>, <span style=color:#66d9ef>T</span><span style=color:#f92672>]</span>
</span></span></code></pre></td></tr></table></div></div><p><code>@@</code> represents a union of two types so values of type <code>@@[V,T]</code> will be equal to values of <code>V</code> at runtime (as <code>T</code> is empty) but we have access to <code>T</code> at compile time.</p><p>We can also write a simple implicit class helper for easy tagging</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Taggable</span><span style=color:#f92672>[</span><span style=color:#66d9ef>V</span><span style=color:#f92672>](</span><span style=color:#66d9ef>val</span> value<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>V</span><span style=color:#f92672>)</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> tag<span style=color:#f92672>[</span><span style=color:#66d9ef>T</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> value<span style=color:#f92672>.</span>asInstanceOf<span style=color:#f92672>[</span><span style=color:#66d9ef>V</span> <span style=color:#66d9ef>@@</span> <span style=color:#66d9ef>T</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> tagAs<span style=color:#f92672>[</span><span style=color:#66d9ef>T</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>V</span> <span style=color:#66d9ef>@@</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> value<span style=color:#f92672>.</span>asInstanceOf<span style=color:#f92672>[</span><span style=color:#66d9ef>T</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>We create values simply by casting as the runtime representation will stay the same.</p><p>Usage may look like</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>TId</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>trait</span> <span style=color:#a6e22e>TUser</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>Id</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Long</span> <span style=color:#f92672>@@</span> <span style=color:#a6e22e>TId</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#66d9ef>UserId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Long</span> <span style=color:#f92672>@@</span> <span style=color:#a6e22e>TUser</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1234.</span>tag<span style=color:#f92672>[</span><span style=color:#66d9ef>TUser</span><span style=color:#f92672>]</span> <span style=color:#75715e>// inferred type: Long @@ TUser
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#ae81ff>5678.</span>tagAs<span style=color:#f92672>[</span><span style=color:#66d9ef>UserId</span><span style=color:#f92672>]</span>
</span></span></code></pre></td></tr></table></div></div><p>A good thing about this approach is that unboxing is automatical since <code>V &lt;:&lt; @@[V,T]</code>. But sometimes you may want to untag your values in order to pass them somewhere where you don&rsquo;t want to keep the tags. For this we just need a function that uses the automatic unboxing</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Untaggable</span><span style=color:#f92672>[</span><span style=color:#66d9ef>V</span>, <span style=color:#66d9ef>T</span><span style=color:#f92672>](</span><span style=color:#66d9ef>val</span> tagged<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>V</span> <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>Tagged</span><span style=color:#f92672>[</span><span style=color:#66d9ef>V</span>, <span style=color:#66d9ef>T</span><span style=color:#f92672>])</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> untag<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>V</span> <span style=color:#f92672>=</span> tagged
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The trick is just to &ldquo;pattern match&rdquo; on the type we implicitly convert.</p><h3 id=collections>Collections</h3><p>Sometimes you want to tag a collection of something. You could <code>xs.map(_.tag[Foo])</code> but this would actually create a new collection at runtime. We can get away just with casting (thus in constant time)!. Notice that collections are nothing special, we may just as well cast a json printer instead of creating a wrapper.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TaggableM</span><span style=color:#f92672>[</span><span style=color:#66d9ef>M</span><span style=color:#f92672>[</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span>, <span style=color:#66d9ef>V</span><span style=color:#f92672>](</span><span style=color:#66d9ef>val</span> value<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>M</span><span style=color:#f92672>[</span><span style=color:#66d9ef>V</span><span style=color:#f92672>])</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> tagM<span style=color:#f92672>[</span><span style=color:#66d9ef>T</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> value<span style=color:#f92672>.</span>asInstanceOf<span style=color:#f92672>[</span><span style=color:#66d9ef>M</span><span style=color:#f92672>[</span><span style=color:#66d9ef>V</span> <span style=color:#66d9ef>@@</span> <span style=color:#66d9ef>T</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> tagAsM<span style=color:#f92672>[</span><span style=color:#66d9ef>T</span> <span style=color:#66d9ef>&lt;:</span> <span style=color:#66d9ef>V</span> <span style=color:#66d9ef>@@</span> <span style=color:#66d9ef>_</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> value<span style=color:#f92672>.</span>asInstanceOf<span style=color:#f92672>[</span><span style=color:#66d9ef>M</span><span style=color:#f92672>[</span><span style=color:#66d9ef>T</span><span style=color:#f92672>]]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>implicit</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UntaggableM</span><span style=color:#f92672>[</span><span style=color:#66d9ef>M</span><span style=color:#f92672>[</span><span style=color:#66d9ef>+</span><span style=color:#66d9ef>_</span><span style=color:#f92672>]</span>, <span style=color:#66d9ef>V</span>, <span style=color:#66d9ef>T</span><span style=color:#f92672>](</span><span style=color:#66d9ef>val</span> tagged<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>M</span><span style=color:#f92672>[</span><span style=color:#66d9ef>V</span> <span style=color:#66d9ef>with</span> <span style=color:#66d9ef>Tagged</span><span style=color:#f92672>[</span><span style=color:#66d9ef>V</span>, <span style=color:#66d9ef>T</span><span style=color:#f92672>]])</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AnyVal</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> untagM<span style=color:#66d9ef>:</span> <span style=color:#66d9ef>M</span><span style=color:#f92672>[</span><span style=color:#66d9ef>V</span><span style=color:#f92672>]</span> <span style=color:#66d9ef>=</span> tagged
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>This is an abstraction over any <code>M[_]</code>. You could write abstractions for other shapes but in practice I never needed anything other since this covers collections and most typeclass instances.</p><h3 id=variance>Variance</h3><p>An observant reader noticed I defined <code>@@</code> to be covariant in both arguments. You probably should leave the value type covariant since it is by nature covariant at runtime but you may change it to invariant if you want to &ldquo;disable&rdquo; automatic upcasting. However the tag type may also be contravariant although I found that covarinace is what you naturally expect and covers most cases. Sadly I haven&rsquo;t found a way to abstract over variance.</p><h3 id=disclaimer>Disclaimer</h3><p>I got this idea from ScalaZ but implemented it in my own way a while ago.</p><hr><p>Last modified on 2015-05-02</p><a href=/posts/2014-10-05-haskell-apis/>Previous Approaches to designing a Haskell API</a><br><a href=/posts/2015-05-03-unary-numbers/>Next Lazy unary numbers</a></div><script src=/js/instantclick.min.js data-no-instant></script>
<script data-no-instant>InstantClick.init("mousedown")</script></body></html>