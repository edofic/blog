<!doctype html><html><head><title>GraphQL ❤️ SQLite</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><style>body{max-width:800px;margin:auto;line-height:1.6;font-size:18px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}.nav a,.nav a:visited,.nav a:hover,.nav a:active{color:inherit}.nav .title{margin:0}.nav-sub{display:inline-block}.nav-item{margin:5px}.nav-sub-right{display:inline-block;float:right}.nav-icon{margin-right:5px}.main img{display:block;max-width:100%;margin:auto}.main pre{overflow:auto}" media="screen"></style></head><body><div hx-boost=true hx-ext=preload><div class=nav preload=mousedown><a href=/><h2 class=title>Andraž Bajt's blog</h2></a><div class=nav-sub><a class=nav-item href=/about/>About Me</a>
<a class=nav-item href=/>Archive</a></div><div class=nav-sub-right><a class=nav-icon href=https://github.com/edofic target=_blank><img src=/icons/github.svg width=20 height=20></a>
<a class=nav-icon href=https://www.linkedin.com/in/edofic target=_blank><img src=/icons/linkedin.svg width=20 height=20></a>
<a class=nav-icon href=https://twitter.com/edofic target=_blank><img src=/icons/twitter.svg width=20 height=20></a>
<a class=nav-icon href=/index.xml target=_blank><img src=/icons/rss.svg width=20 height=20></a>
<a class=nav-icon href=mailto:blog@edofic.com target=_blank><img src=/icons/email.svg width=20 height=20></a></div></div><hr><div class=main preload=mousedown><h1>GraphQL ❤️ SQLite</h1><time>2023-05-06</time><hr><p>If you&rsquo;ve done anything nontrivial with GraphQL you&rsquo;re probably familiar with
how &ldquo;N+1 select problem&rdquo; sneaks up on you. If not, this is how <a href=https://gqlgen.com/reference/dataloaders/>gqlgen
docs</a> explain it:</p><blockquote><p>Imagine your graph has query that lists todos…</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-graphql data-lang=graphql><span style=display:flex><span><span style=color:#66d9ef>query</span> { <span style=color:#a6e22e>todos</span> { user { name } } }
</span></span></code></pre></td></tr></table></div></div><blockquote><p>and the todo.user resolver reads the User from a database…</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>todoResolver</span>) <span style=color:#a6e22e>User</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>obj</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>Todo</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>User</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>LogAndQuery</span>(
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Conn</span>,
</span></span><span style=display:flex><span>		<span style=color:#e6db74>&#34;SELECT id, name FROM users WHERE id = ?&#34;</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>obj</span>.<span style=color:#a6e22e>UserID</span>,
</span></span><span style=display:flex><span>	)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Next</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>user</span> <span style=color:#a6e22e>model</span>.<span style=color:#a6e22e>User</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Scan</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>Name</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>user</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><blockquote><p>The query executor will call the Query.Todos resolver which does a select *
from todo and returns N todos. If the nested User is selected, the above
UserRaw resolver will run a separate query for each user, resulting in N+1
database queries. e.g.</p></blockquote><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, todo, user_id <span style=color:#66d9ef>FROM</span> todo
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, name <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, name <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, name <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, name <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, name <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> id, name <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>WHERE</span> id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>Whats even worse? most of those todos are all owned by the same user! We can
do better than this.</p></blockquote><p>And then goes on to explain how to use a <a href=https://github.com/graph-gophers/dataloader>dataloader</a> to solve this by effectively batching and deduplicating queries.
The solution is neat and the damage to your resolver logic minimal. Heck, I use this in production at work. So what&rsquo;s the issue exactly?</p><h1 id=enter-sqlite>Enter SQLite</h1><p><img src=/images/we-dont-need-batching.jpeg alt="where we&amp;rsquo;re going we don&amp;rsquo;t need batching"></p><p>The above wisdom only applies when you use an external database. The performance characteristics of using an embedded database (e.g. SQLite) are different. In fact the SQLite homepage explicitly claims that <a href=https://www.sqlite.org/np1queryprob.html>Many Small Queries Are Efficient In SQLite
</a>.</p><p>So how does that apply? We&rsquo;ll you can just skip dataloders and naively query. And the performance will be similar. See there is a minimal overhead to doing a query but since in the above case where you&rsquo;re repeatedly hitting the same user it&rsquo;s pretty much guaranteed to already be in memory most of the time. So the overhead is minimal compared to a map lookup - which you would be doing otherwise. And there is a cost to using a dataloader too, including (but not limited to) having to wait a bit before firing a query because you don&rsquo;t know if more are coming or not. And this may actually be the limiting factor for getting your response latency down for cheap requests.</p><p>So GraphQL loves to make a lot of small queries and SQLite is very good at handling that. Truly a match made in heaven.</p><hr><p>Last modified on 2023-05-06</p><a href=/blog/2023-03-31-awk-chatgpt/>Previous (Re)Learning AWK with ChatGPT</a><br><a>No newer posts.</a></div></div><script src=/js/htmx.min.js></script>
<script src=/js/preload.js></script></body></html>